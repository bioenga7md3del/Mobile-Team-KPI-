<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Mobile Team Monthly Maintenance KPIs ‚Äì September 2025</title>
<style>
:root{
  --bg:#f3f4f6; --panel:#ffffff; --muted:#6b7280; --text:#1e293b;
  --card:#f9fafb; --border:#e5e7eb; --shadow:0 6px 18px rgba(0,0,0,.06);
  --gold:#f59e0b;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:Roboto,Arial,"Segoe UI",sans-serif}
.container{max-width:1280px;margin:32px auto;padding:0 18px}
.brandbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.brandlogo{background:#fff;border:1px solid var(--border);border-radius:16px;padding:8px;box-shadow:var(--shadow)}
.brandlogo img{height:56px;display:block;background:#fff}
header.brand{text-align:center}
h1{margin:6px 0 2px 0;font-size:28px;font-weight:800}
.subtitle{margin:0;color:var(--muted);font-size:14px}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:16px 0}
.toolbar .input{background:#fff;border:1px solid var(--border);padding:8px 12px;border-radius:12px}
.toolbar button{padding:10px 16px;border:1px solid var(--border);border-radius:999px;background:#fff;font-weight:800;cursor:pointer;box-shadow:var(--shadow)}
.tabs{position:sticky;top:0;background:rgba(243,244,246,.95);backdrop-filter:saturate(140%) blur(4px);display:flex;gap:10px;margin:18px 0;padding:10px;border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);z-index:2;justify-content:center;flex-wrap:wrap}
.tab{padding:10px 16px;border:1px solid var(--border);background:#fff;border-radius:999px;cursor:pointer;font-weight:700}
.tab.active{background:var(--card)}
.view{display:none}
.view.active{display:block}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:var(--shadow);margin-bottom:14px}
.card h3{margin:0 0 10px 0}
table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden;box-shadow:var(--shadow)}
th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;font-size:14px}
thead th{background:#eef2f7}
.badge{display:inline-block;padding:4px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;margin-left:8px;color:#334155;font-weight:700}
.reveal{text-align:center;margin:6px 0 12px 0}
.reveal button{padding:10px 16px;border:1px solid var(--border);border-radius:999px;background:#fff;font-weight:800;cursor:pointer;box-shadow:var(--shadow)}
.winners{margin-top:10px;border:2px solid var(--gold);background:linear-gradient(180deg,#fffaf0,#fff4d6);border-radius:20px;padding:16px;box-shadow:var(--shadow);display:none}
.winner-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.winner-grid .slot{background:#fff;border:1px solid #fcd34d;border-radius:14px;padding:12px;text-align:center}
.winner-grid .first{border-width:2px}
details.tech{background:#fff;border:1px solid var(--border);border-radius:12px;margin-bottom:12px;box-shadow:var(--shadow)}
details.tech>summary{cursor:pointer;list-style:none;padding:12px 14px;font-weight:800;color:#111827}
details.tech>summary::-webkit-details-marker{display:none}
.kv{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:8px 0}
.kv div{background:#f9fafb;padding:8px;border:1px solid var(--border);border-radius:10px}
.bar{height:10px;background:#e5e7eb;border-radius:8px;overflow:hidden}
.bar>span{display:block;height:100%;background:#60a5fa}
footer{margin:14px 0;text-align:center}
.small{color:#6b7280;font-size:12px}
</style>
</head>
<body>
<div class="container">
  <div class="brandbar">
    <div class="brandlogo"><img src="TabukCluster.jpeg" alt="Tabuk Health Cluster"></div>
    <div class="brandlogo"><img src="FGC.jpeg" alt="FGC"></div>
  </div>
  <header class="brand">
    <h1>Mobile Team Monthly Maintenance KPIs ‚Äì September 2025</h1>
    <div class="subtitle">Performance Analysis for the Mobile Maintenance Team ‚Äì Tabuk Region</div>
  </header>

  <div class="toolbar">
    <label class="input">Corrective CSV: <input id="file-corrective" type="file" accept=".csv"/></label>
    <label class="input">PPM CSV: <input id="file-ppm" type="file" accept=".csv"/></label>
    <button id="build">Build Dashboard</button>
    <span class="small">Tip: Save Wo.xlsx &amp; ppm.xlsx as CSV first (same folder as this file).</span>
  </div>

  <div class="tabs">
    <button class="tab active" data-target="combined">üèÜ Combined (Overall)</button>
    <button class="tab" data-target="corrective">üîß Corrective WO</button>
    <button class="tab" data-target="ppm">üõ†Ô∏è PPM WO</button>
  </div>

  <div id="combined" class="view active"></div>
  <div id="corrective" class="view"></div>
  <div id="ppm" class="view"></div>

  <footer>
    <strong>Evaluation prepared by Eng. Ahmed Adel ‚Äì Mobile Maintenance Project Manager</strong>
  </footer>
</div>

<script>
/* ---- CSV helpers ---- */
function parseCSV(text){
  const rows=[]; let i=0, cur="", inQ=false; const push=()=>{rows[rows.length-1].push(cur);cur="";}
  rows.push([]);
  for(;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if(inQ){
      if(c==='"' && n==='"'){cur+='"'; i++; continue;}
      if(c==='"'){inQ=false; continue;}
      cur+=c; continue;
    }
    if(c==='"' && cur===""){inQ=true; continue;}
    if(c===','){push(); continue;}
    if(c==='\n'){push(); rows.push([]); continue;}
    if(c==='\r'){continue;}
    cur+=c;
  }
  push();
  if(rows.length && rows[rows.length-1].length===1 && rows[rows.length-1][0]==="") rows.pop();
  return rows;
}
function toObjects(rows){
  if(!rows.length) return [];
  const header = rows[0].map(h=>String(h||"").trim());
  return rows.slice(1).map(r=>{
    const o={};
    header.forEach((h,idx)=>{o[h]=r[idx]!==undefined?r[idx]:"";});
    return o;
  });
}
function num(v){
  if(v===null||v===undefined) return NaN;
  const s=String(v).trim();
  if(s==="") return NaN;
  const n=Number(s.replace(/,/g,""));
  return isNaN(n)?NaN:n;
}
function detectCols(header){
  let tech=null, resp=null, rep=null;
  header.forEach((h,idx)=>{
    const lc=h.toLowerCase();
    if(!tech && (lc.includes("assigned to")||lc.includes("technician")||lc.includes("ÿßŸÑŸÅŸÜŸä")||lc.includes("assignee")||lc==="assigned")) tech=idx;
    if(!resp && lc.includes("kpi") && (lc.includes("res")||lc.includes("resp")||lc.includes("response")||lc.includes("respose"))) resp=idx;
    if(!rep  && lc.includes("kpi") && (lc.includes("rep")||lc.includes("repair")||lc.includes("repaired")||lc.includes("repierd"))) rep=idx;
  });
  if(tech==null) tech=0;
  if(resp==null){ header.forEach((h,i)=>{ if(/res.*kpi/i.test(h)) resp=i; }); }
  if(rep==null){ header.forEach((h,i)=>{ if(/rep.*kpi/i.test(h)) rep=i; }); }
  return {tech,resp,rep};
}
function computeKPI(rows){
  if(!rows.length) return [];
  const cols=detectCols(rows[0]);
  const body=rows.slice(1);
  const map=new Map();
  body.forEach(r=>{
    const name=String(r[cols.tech]??"").trim()||"Unassigned";
    const resp=num(r[cols.resp]);
    const rep =num(r[cols.rep]);
    const under = isNaN(rep); // no Repair KPI => still under repair
    if(!map.has(name)) map.set(name,{Technician:name, n:0, respSum:0, repSum:0, repN:0, finished:0, under:0});
    const o=map.get(name);
    o.n+=1;
    if(!isNaN(resp)) o.respSum+=resp;
    if(!isNaN(rep)) {o.repSum+=rep; o.repN+=1;}
    if(under) o.under+=1; else o.finished+=1;
  });
  const out=[...map.values()].map(o=>{
    const Avg_Response_Days = o.n? +(o.respSum/o.n).toFixed(2):0;
    const Avg_Repair_Days   = o.repN? +(o.repSum/o.repN).toFixed(2):0;
    const Finished=o.finished, UnderRepair=o.under, WorkOrders=o.n;
    const denom=Finished+UnderRepair;
    const CompletionRate = denom? +((Finished/denom)*100).toFixed(1):0;
    return {Technician:o.Technician, Avg_Response_Days, Avg_Repair_Days, Finished, UnderRepair, CompletionRate_%:CompletionRate, WorkOrders};
  });
  return out;
}
function rankLogic(arr){
  return arr.slice().sort((a,b)=>{
    if(b.CompletionRate_%!==a.CompletionRate_%) return b.CompletionRate_%-a.CompletionRate_%;
    if(a.Avg_Response_Days!==b.Avg_Response_Days) return a.Avg_Response_Days-b.Avg_Response_Days;
    if(a.Avg_Repair_Days!==b.Avg_Repair_Days) return a.Avg_Repair_Days-b.Avg_Repair_Days;
    return b.WorkOrders-a.WorkOrders;
  });
}
/* UI helpers */
function percentBar(pct){
  const v=Math.max(0,Math.min(100, pct||0));
  return `<div class="bar"><span style="width:${v}%"></span></div>`;
}
function tableHTML(arr, title){
  const rows=arr.map(r=>`
    <tr>
      <td><button class="link-tech" data-name="${r.Technician}">${r.Technician}</button></td>
      <td>${r.Avg_Response_Days}</td>
      <td>${r.Avg_Repair_Days}</td>
      <td>${r.Finished}</td>
      <td>${r.UnderRepair}</td>
      <td>${r.CompletionRate_%}% ${percentBar(r.CompletionRate_%)}</td>
      <td>${r.WorkOrders}</td>
    </tr>`).join("");
  return `
    <div class="card">
      <h3>Technicians ‚Äì KPI Summary <span class="badge">${title}</span></h3>
      <table>
        <thead><tr>
          <th>Technician</th><th>Avg_Response_Days</th><th>Avg_Repair_Days</th>
          <th>Finished</th><th>UnderRepair</th><th>CompletionRate_%</th><th>WorkOrders</th>
        </tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;
}
function winnersHTML(title, ranked){
  const top1=ranked[0]?.Technician||"", top2=ranked[1]?.Technician||"", top3=ranked[2]?.Technician||"", last=ranked[ranked.length-1]?.Technician||"";
  const key=title.toLowerCase().replace(/\s+/g,'_');
  return `
    <div class="reveal">
      <button id="reveal_${key}">Click to Reveal Winners üèÜ</button>
      <div class="winners" id="wins_${key}" style="display:none">
        <div class="winner-grid">
          <div class="slot first"><b>#1</b><div>${top1}</div></div>
          <div class="slot"><b>#2</b><div>${top2}</div></div>
          <div class="slot"><b>#3</b><div>${top3}</div></div>
          <div class="slot last"><b>Last</b><div>${last}</div></div>
        </div>
      </div>
    </div>
    <script>
      (function(){
        var b=document.getElementById('reveal_${key}');
        var w=document.getElementById('wins_${key}');
        if(b&&w){
          b.addEventListener('click', function(){
            var open=w.style.display==='block';
            w.style.display=open?'none':'block';
            b.textContent=open?'Click to Reveal Winners üèÜ':'Hide Winners';
          });
        }
      })();
    </script>`;
}
function median(arr){
  const v=arr.filter(x=>typeof x==="number" && !isNaN(x)).sort((a,b)=>a-b);
  if(!v.length) return 0;
  const m=Math.floor(v.length/2);
  return v.length%2? v[m] : (v[m-1]+v[m])/2;
}
function drilldownHTML(arr){
  if(!arr.length) return "";
  const respMed = median(arr.map(a=>a.Avg_Response_Days));
  const repMed  = median(arr.map(a=>a.Avg_Repair_Days));
  const compMed = median(arr.map(a=>a.CompletionRate_%));
  const items = arr.map(r=>{
    const recs = [];
    recs.push(r.Avg_Response_Days<=respMed ? "Great response ‚Äî keep same-day acknowledgement." : "Aim for same-day acknowledgement on new WOs.");
    recs.push(r.Avg_Repair_Days<=repMed ? "Solid repair speed ‚Äî document fixes to playbook." : "Prepare spares & pre-diagnosis to reduce downtime.");
    recs.push(r.CompletionRate_%>=compMed ? "Good closure rate ‚Äî keep daily wrap-up." : "Close pending jobs daily & escalate blockers early.");
    return `
      <details class="tech"><summary>${r.Technician}</summary>
        <div class="kv">
          <div><span>Work Orders</span><strong>${r.WorkOrders}</strong></div>
          <div><span>Avg Response (d)</span><strong>${r.Avg_Response_Days}</strong></div>
          <div><span>Avg Repair (d)</span><strong>${r.Avg_Repair_Days}</strong></div>
          <div><span>Finished</span><strong>${r.Finished}</strong></div>
          <div><span>Under Repair</span><strong>${r.UnderRepair}</strong></div>
          <div><span>Completion %</span><strong>${r.CompletionRate_%}</strong></div>
        </div>
        <h4>How KPIs are calculated</h4>
        <ul>
          <li><b>Avg Response</b> = mean(Start ‚àí Fail) days</li>
          <li><b>Avg Repair</b> = mean(Sign Off ‚àí Fail) days</li>
          <li><b>Completion</b> = Finished √∑ (Finished + Under Repair)</li>
        </ul>
        <h4>Recommendations</h4>
        <ul>${recs.map(x=>`<li>${x}</li>`).join("")}</ul>
      </details>`;
  }).join("");
  return `<div class="card"><h3>Per-Technician Drill-down & Recommendations</h3>${items}</div>`;
}
function buildSection(targetEl, title, ranked){
  targetEl.innerHTML = `
    ${winnersHTML(title, ranked)}
    ${tableHTML(ranked, title)}
    ${drilldownHTML(ranked)}
  `;
}
/* ---- Tabs ---- */
document.querySelectorAll('.tab').forEach(function(btn){
  btn.addEventListener('click', function(){
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.dataset.target).classList.add('active');
    window.scrollTo({top:0,behavior:'smooth'});
  });
});
/* ---- Build ---- */
document.getElementById("build").addEventListener("click", async ()=>{
  const fCor = document.getElementById("file-corrective").files[0];
  const fPPM = document.getElementById("file-ppm").files[0];
  if(!fCor || !fPPM){ alert("Please select both Corrective CSV and PPM CSV."); return; }
  const [t1, t2] = await Promise.all([fCor.text(), fPPM.text()]);
  const rowsCor = parseCSV(t1), rowsPPM = parseCSV(t2);

  const cor = rankLogic( computeKPI(rowsCor) );
  const ppm = rankLogic( computeKPI(rowsPPM) );
  // combined weighted by WorkOrders
  const byName = new Map();
  function add(arr){
    arr.forEach(x=>{
      const k=x.Technician;
      if(!byName.has(k)) byName.set(k,{Technician:k, w:0, respW:0, repW:0, fin:0, und:0});
      const o=byName.get(k);
      o.w+=x.WorkOrders;
      o.respW+=x.Avg_Response_Days*x.WorkOrders;
      o.repW +=x.Avg_Repair_Days*x.WorkOrders;
      o.fin+=x.Finished; o.und+=x.UnderRepair;
    });
  }
  add(cor); add(ppm);
  const combined = Array.from(byName.values()).map(o=>{
    const w = Math.max(1,o.w);
    const Avg_Response_Days = +(o.respW/w).toFixed(2);
    const Avg_Repair_Days   = +(o.repW/w).toFixed(2);
    const Finished=o.fin, UnderRepair=o.und, WorkOrders=o.w;
    const denom=Finished+UnderRepair;
    const CompletionRate_% = denom? +((Finished/denom)*100).toFixed(1):0;
    return {Technician:o.Technician, Avg_Response_Days, Avg_Repair_Days, Finished, UnderRepair, CompletionRate_% , WorkOrders};
  }).sort((a,b)=>{
    if(b.CompletionRate_%!==a.CompletionRate_%) return b.CompletionRate_%-a.CompletionRate_%;
    if(a.Avg_Response_Days!==b.Avg_Response_Days) return a.Avg_Response_Days-b.Avg_Response_Days;
    if(a.Avg_Repair_Days!==b.Avg_Repair_Days) return a.Avg_Repair_Days-b.Avg_Repair_Days;
    return b.WorkOrders-a.WorkOrders;
  });

  buildSection(document.getElementById("corrective"), "Corrective", cor);
  buildSection(document.getElementById("ppm"), "PPM", ppm);
  buildSection(document.getElementById("combined"), "Combined", combined);
});
</script>
</body>
</html>
