<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Mobile Team Monthly Maintenance KPIs – October 2025</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net"/>
<link rel="dns-prefetch" href="https://cdn.jsdelivr.net"/>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
:root {
  --bg:#ffffff; --text:#1f2937; --muted:#6b7280; --card:#f9fafb; --border:#e5e7eb;
  --btn:#f3f4f6; --btn-border:#d1d5db;
  --green:#10b981; --red:#ef4444;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;}
.container{max-width:1250px;margin:28px auto;padding:0 16px;}
header.brand{position:relative;display:grid;grid-template-columns:180px 1fr 260px;align-items:center;gap:18px;margin-bottom:12px;}
.logo-wrap{background:#ffffff;border:1px solid var(--border);border-radius:12px;padding:10px;display:flex;align-items:center;justify-content:center;min-height:100px}
.logo-wrap img{max-width:160px;height:auto;display:block}
.title-wrap{text-align:center}
h1.title{margin:4px 0;font-size:28px;font-weight:800;color:#111827}
p.subtitle{margin:2px 0;color:var(--muted);font-size:14px}
.controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
.file{border:1px dashed var(--border);background:#fff;border-radius:10px;padding:6px 8px}
.tabs{display:flex;gap:8px;margin:16px 0;flex-wrap:wrap}
.tab{padding:10px 16px;border:1px solid var(--btn-border);background:var(--btn);border-radius:999px;cursor:pointer}
.tab.active{border-color:#9ca3af;box-shadow:0 0 0 2px rgba(0,0,0,.04) inset}
.view{display:none}
.view.active{display:block}
.grid{display:grid;grid-template-columns:1fr;gap:18px}
@media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
.chart{width:100%;height:330px;border:1px solid var(--border);border-radius:10px;background:#fff}
.kpigrid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.kpi{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px}
.kpi span{display:block;color:var(--muted);font-size:12px;margin-bottom:4px}
.kpi b{font-size:18px}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:700;margin-left:8px}
.badge.green{background:rgba(16,185,129,.12);color:#065f46;border:1px solid rgba(16,185,129,.4)}
.badge.red{background:rgba(239,68,68,.12);color:#7f1d1d;border:1px solid rgba(239,68,68,.4)}
table{width:100%;border-collapse:collapse;border:1px solid var(--border);background:#fff;border-radius:12px;overflow:hidden}
thead th{background:#f3f4f6;color:#111827;text-align:left;font-weight:700;font-size:14px;padding:10px;border-bottom:1px solid var(--border)}
tbody td{padding:10px;border-bottom:1px solid var(--border);color:#1f2937;font-size:14px}
details.site{background:#fff;border:1px solid var(--border);border-radius:12px;margin-bottom:10px}
details.site>summary{cursor:pointer;list-style:none;padding:12px 14px;font-weight:800;color:#111827}
details.site>summary::-webkit-details-marker{display:none}
.site-body{padding:0 14px 14px}
.kv{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:10px 0}
.kv div{background:#f9fafb;padding:10px;border-radius:10px;border:1px solid var(--border)}
.kv span{color:var(--muted);font-size:12px;display:block}
footer{color:var(--muted);font-size:12px;margin:16px 0}
</style>
</head>
<body>
<div class="container">
  <header class="brand">
    <div class="logo-wrap">
      <img src="./TabukCluster.jpeg" alt="Tabuk Logo" onerror="this.style.display='none'"/>
    </div>
    <div class="title-wrap">
      <h1 class="title">Mobile Team Monthly Maintenance KPIs – October 2025</h1>
      <p class="subtitle">Corrective & Preventive Maintenance • Tabuk Health Cluster</p>
      <p class="subtitle">Prepared by: قسم الصيانة الطبية بتجمع تبوك الصحي</p>
    </div>
    <div class="controls">
      <label class="file">Corrective WO.xlsx <input type="file" id="file-cm" accept=".xlsx,.xls"/></label>
      <label class="file">Preventive ppm.xlsx <input type="file" id="file-pm" accept=".xlsx,.xls"/></label>
      <button class="tab" id="btn-run">Load & Calculate</button>
      <button class="tab" id="btn-lang">EN / AR</button>
    </div>
  </header>

  <div class="tabs">
    <button class="tab active" id="tab-cm">Corrective</button>
    <button class="tab" id="tab-pm">Preventive</button>
    <button class="tab" id="tab-combined">Combined</button>
  </div>

  <!-- Corrective -->
  <div id="cm" class="view active">
    <section class="block card">
      <h3>Summary</h3>
      <div id="cm-kpis" class="kpigrid"></div>
    </section>
    <div class="grid">
      <section class="card">
        <h3>Total Work Orders by Site</h3>
        <svg id="cm-total" class="chart"></svg>
      </section>
      <section class="card">
        <h3>Open vs Closed</h3>
        <svg id="cm-pie" class="chart"></svg>
      </section>
    </div>
    <div class="grid">
      <section class="card">
        <h3>Avg. Repair Days by Site</h3>
        <svg id="cm-repair" class="chart"></svg>
      </section>
      <section class="card">
        <h3>Top 10 Devices (ECRI)</h3>
        <svg id="cm-dev" class="chart"></svg>
      </section>
    </div>
    <section class="block card">
      <h3>Corrective – Ranking (Top 12)</h3>
      <div style="overflow:auto">
        <table id="cm-rank"></table>
      </div>
    </section>
    <section class="block card">
      <h3>Sites – Details & Recommendations</h3>
      <div id="cm-sites"></div>
    </section>
  </div>

  <!-- Preventive -->
  <div id="pm" class="view">
    <section class="block card">
      <h3>Summary</h3>
      <div id="pm-kpis" class="kpigrid"></div>
    </section>
    <div class="grid">
      <section class="card">
        <h3>Total Work Orders by Site</h3>
        <svg id="pm-total" class="chart"></svg>
      </section>
      <section class="card">
        <h3>Open vs Closed</h3>
        <svg id="pm-pie" class="chart"></svg>
      </section>
    </div>
    <div class="grid">
      <section class="card">
        <h3>Avg. Repair Days by Site</h3>
        <svg id="pm-repair" class="chart"></svg>
      </section>
    </div>
    <section class="block card">
      <h3>Preventive – Ranking (Top 12)</h3>
      <div style="overflow:auto">
        <table id="pm-rank"></table>
      </div>
    </section>
    <section class="block card">
      <h3>Sites – Details & Recommendations</h3>
      <div id="pm-sites"></div>
    </section>
  </div>

  <!-- Combined -->
  <div id="combined" class="view">
    <section class="block card">
      <h3>Summary</h3>
      <div id="co-kpis" class="kpigrid"></div>
    </section>
    <div class="grid">
      <section class="card">
        <h3>Total Work Orders by Site</h3>
        <svg id="co-total" class="chart"></svg>
      </section>
      <section class="card">
        <h3>Open vs Closed</h3>
        <svg id="co-pie" class="chart"></svg>
      </section>
    </div>
    <div class="grid">
      <section class="card">
        <h3>Avg. Repair Days by Site</h3>
        <svg id="co-repair" class="chart"></svg>
      </section>
    </div>
    <section class="block card">
      <h3>Combined – Ranking (Top 12)</h3>
      <div style="overflow:auto">
        <table id="co-rank"></table>
      </div>
    </section>
    <section class="block card">
      <h3>Sites – Details & Recommendations</h3>
      <div id="co-sites"></div>
    </section>
  </div>

  <footer>
    Generated: <span id="gen-time"></span>
  </footer>
</div>

<script>
// Expected columns
const COL = {
  site: 'Site',
  resp: 'Response KPI',
  rep:  'Repierd KPI',
  ecri: 'ECRI Code'
};

let CM = null, PM = null;

// Tabs
(function(){
  const tabs = [
    {btn:'tab-cm', view:'cm'},
    {btn:'tab-pm', view:'pm'},
    {btn:'tab-combined', view:'combined'}
  ];
  function setActive(id){
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
    const t = tabs.find(x=>x.view===id);
    if(t){
      document.getElementById(t.btn).classList.add('active');
      document.getElementById(t.view).classList.add('active');
    }
  }
  tabs.forEach(t=>document.getElementById(t.btn).addEventListener('click', ()=>setActive(t.view)));
})();

// Lang toggle
document.getElementById('btn-lang').addEventListener('click', ()=>{
  const html = document.documentElement;
  if(html.getAttribute('dir')==='rtl'){ html.removeAttribute('dir'); html.setAttribute('lang','en'); }
  else{ html.setAttribute('dir','rtl'); html.setAttribute('lang','ar'); }
});

// Read Excel (largest sheet)
function readExcel(file){
  return new Promise((res,rej)=>{
    const reader = new FileReader();
    reader.onload = e => {
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data, {type:'array'});
      const wsname = wb.SheetNames.reduce((a,b)=>{
        const lenA = XLSX.utils.sheet_to_json(wb.Sheets[a],{defval:null}).length;
        const lenB = XLSX.utils.sheet_to_json(wb.Sheets[b],{defval:null}).length;
        return lenB>lenA?b:a;
      });
      const ws = wb.Sheets[wsname];
      const rows = XLSX.utils.sheet_to_json(ws, {defval:null});
      res(rows);
    };
    reader.onerror = rej;
    reader.readAsArrayBuffer(file);
  });
}

document.getElementById('btn-run').addEventListener('click', async ()=>{
  const fcm = document.getElementById('file-cm').files[0];
  const fpm = document.getElementById('file-pm').files[0];
  if(!fcm || !fpm){ alert('Please select both Corrective and Preventive Excel files.'); return; }
  CM = await readExcel(fcm);
  PM = await readExcel(fpm);
  calculateAndRender(CM, PM);
  document.getElementById('gen-time').textContent = new Date().toLocaleString();
});

function numDays(val){
  if(val===null || val===undefined) return NaN;
  const s = String(val).trim().toLowerCase();
  if(s==='' || s==='null' || s==='nan' || s==='none') return NaN;
  const n = Number(s.replaceAll(',',''));
  return isFinite(n) ? n : NaN;
}
function isNullish(val){
  if(val===null || val===undefined) return true;
  const s = String(val).trim().toLowerCase();
  return (s==='' || s==='null' || s==='nan' || s==='none');
}

function groupBySite(rows){
  const siteMap = new Map();
  for(const r of rows){
    const site = (r[COL.site] ?? '(blank)').toString().trim();
    const respDays = numDays(r[COL.resp]);
    const repDays  = numDays(r[COL.rep]);
    const isOpen   = isNullish(r[COL.rep]);
    if(!siteMap.has(site)){
      siteMap.set(site, {site, total:0, open:0, closed:0, respSum:0, respN:0, repSum:0, repN:0});
    }
    const s = siteMap.get(site);
    s.total += 1;
    s.open  += isOpen ? 1 : 0;
    s.closed = s.total - s.open;
    if(!Number.isNaN(respDays)){ s.respSum += respDays; s.respN += 1; }
    if(!Number.isNaN(repDays)){ s.repSum  += repDays;  s.repN  += 1; }
  }
  const arr = Array.from(siteMap.values()).map(x=>({
    site:x.site,
    total_wo:x.total,
    open_wo:x.open,
    closed_wo:x.closed,
    avg_response_days: x.respN? x.respSum/x.respN : null,
    avg_repair_days:   x.repN? x.repSum/x.repN : null,
    open_rate_pct: x.total? (x.open/x.total*100) : null
  }));
  return arr;
}

function groupBySitePM(rows){
  const siteMap = new Map();
  for(const r of rows){
    const site = (r[COL.site] ?? '(blank)').toString().trim();
    const respDays = numDays(r[COL.resp]);
    const repDays  = numDays(r[COL.rep]);
    const respNull = isNullish(r[COL.resp]);
    const repNull  = isNullish(r[COL.rep]);
    const isClosed = Number.isFinite(repDays) && repDays>=0;
    const isOpen   = repNull || respNull; // OPEN includes NOT OPENED
    const isNotOpened = respNull;

    if(!siteMap.has(site)){
      siteMap.set(site, {site, total:0, open:0, closed:0, notOpened:0, respSum:0, respN:0, repSum:0, repN:0});
    }
    const s = siteMap.get(site);
    s.total += 1;
    s.open  += isOpen ? 1 : 0;
    s.notOpened += isNotOpened ? 1 : 0;
    if(isClosed) s.closed += 1;
    else s.closed = s.total - s.open;

    if(!Number.isNaN(respDays)){ s.respSum += respDays; s.respN += 1; }
    if(!Number.isNaN(repDays)){ s.repSum  += repDays;  s.repN  += 1; }
  }
  const arr = Array.from(siteMap.values()).map(x=>({
    site:x.site,
    total_wo:x.total,
    open_wo:x.open,
    closed_wo:x.closed,
    not_opened:x.notOpened,
    avg_response_days: x.respN? x.respSum/x.respN : null,
    avg_repair_days:   x.repN? x.repSum/x.repN : null,
    open_rate_pct: x.total? (x.open/x.total*100) : null
  }));
  return arr;
}

function topDevicesCM(rows){
  const counts = new Map();
  for(const r of rows){
    const d = (r[COL.ecri] ?? '(blank)').toString().trim();
    counts.set(d, (counts.get(d)||0)+1);
  }
  return Array.from(counts.entries()).sort((a,b)=>b[1]-a[1]).slice(0,10)
              .map(([device,count])=>({device,count}));
}

function metricsSummary(arr, withNotOpened=false){
  const t = arr.reduce((a,b)=>a+b.total_wo,0);
  const o = arr.reduce((a,b)=>a+b.open_wo,0);
  const c = arr.reduce((a,b)=>a+b.closed_wo,0);
  const or = t? (o/t*100):0;
  const respVals = arr.map(x=>x.avg_response_days).filter(v=>Number.isFinite(v));
  const repVals  = arr.map(x=>x.avg_repair_days).filter(v=>Number.isFinite(v));
  const notOpened = withNotOpened ? arr.reduce((a,b)=>a+(b.not_opened||0),0) : null;
  return {
    total_wo:t, open_wo:o, closed_wo:c, open_rate_pct:or,
    avg_response_days: respVals.length? avg(respVals): null,
    avg_repair_days: repVals.length? avg(repVals): null,
    not_opened: notOpened
  };
}
function avg(a){ return a.reduce((x,y)=>x+y,0)/a.length; }

function combinedFrom(cm, pm){
  const map = new Map();
  function add(arr){
    for(const r of arr){
      if(!map.has(r.site)) map.set(r.site, {site:r.site, total_wo:0, open_wo:0, closed_wo:0, respVals:[], repVals:[]});
      const s = map.get(r.site);
      s.total_wo += r.total_wo;
      s.open_wo  += r.open_wo;
      s.closed_wo+= r.closed_wo;
      if(Number.isFinite(r.avg_response_days)) s.respVals.push(r.avg_response_days);
      if(Number.isFinite(r.avg_repair_days)) s.repVals.push(r.avg_repair_days);
    }
  }
  add(cm); add(pm);
  return Array.from(map.values()).map(s=>({
    site:s.site,
    total_wo:s.total_wo,
    open_wo:s.open_wo,
    closed_wo:s.closed_wo,
    avg_response_days: s.respVals.length? avg(s.respVals): null,
    avg_repair_days:   s.repVals.length? avg(s.repVals): null,
    open_rate_pct: s.total_wo? (s.open_wo/s.total_wo*100) : null
  }));
}

function renderKPIs(el, meta, extra=false){
  el.innerHTML = `
    <div class="kpi"><span>Total Work Orders</span><b>${meta.total_wo.toLocaleString()}</b></div>
    <div class="kpi"><span>Open Work Orders</span><b>${meta.open_wo.toLocaleString()} <i class="badge red">Open</i></b></div>
    <div class="kpi"><span>Closed Work Orders</span><b>${meta.closed_wo.toLocaleString()} <i class="badge green">Closed</i></b></div>
    <div class="kpi"><span>Open Rate</span><b>${meta.open_rate_pct.toFixed(1)}%</b></div>
    <div class="kpi"><span>Avg. Response (days)</span><b>${meta.avg_response_days!=null ? meta.avg_response_days.toFixed(2) : "—"}</b></div>
    <div class="kpi"><span>Avg. Repair (days)</span><b>${meta.avg_repair_days!=null ? meta.avg_repair_days.toFixed(2) : "—"}</b></div>
    ${extra && meta.not_opened!=null ? `<div class="kpi"><span>Not Opened (Response KPI blank)</span><b>${meta.not_opened.toLocaleString()}</b></div>`: ""}
  `;
}

function drawBar(svg, items, xKey, yKey){
  const w = svg.clientWidth, h = svg.clientHeight, pad=40;
  svg.innerHTML='';
  const max = Math.max(1, ...items.map(d=>+d[yKey]||0));
  const barW = (w - pad*2) / (items.length || 1);
  // axis
  const axis = document.createElementNS("http://www.w3.org/2000/svg", "line");
  axis.setAttribute("x1", pad); axis.setAttribute("y1", h-pad);
  axis.setAttribute("x2", w-pad); axis.setAttribute("y2", h-pad);
  axis.setAttribute("stroke", "#9ca3af"); axis.setAttribute("stroke-width", "1");
  svg.appendChild(axis);
  items.forEach((d,i)=>{
    const x = pad + i*barW + 5;
    const y = h - pad - ( (d[yKey]||0)/max * (h-pad*2) );
    const rect = document.createElementNS("http://www.w3.org/2000/svg","rect");
    rect.setAttribute("x", x); rect.setAttribute("y", y);
    rect.setAttribute("width", Math.max(2, barW-10));
    rect.setAttribute("height", (h-pad) - y);
    rect.setAttribute("fill", "#60a5fa");
    svg.appendChild(rect);
    const label = document.createElementNS("http://www.w3.org/2000/svg","text");
    label.setAttribute("x", x + (barW-10)/2);
    label.setAttribute("y", h-10);
    label.setAttribute("font-size","10");
    label.setAttribute("text-anchor","middle");
    label.textContent = String(d[xKey]).slice(0,12);
    svg.appendChild(label);
  });
}

function drawPie(svg, openCount, closedCount){
  const w = svg.clientWidth, h = svg.clientHeight;
  svg.innerHTML='';
  const r = Math.min(w,h)/2 - 10, cx=w/2, cy=h/2;
  const total = Math.max(1, openCount+closedCount);
  const parts = [
    {val:openCount, color:"#ef4444"},   // red
    {val:closedCount, color:"#10b981"}  // green
  ];
  let ang0 = -Math.PI/2;
  parts.forEach(p=>{
    const ang = p.val/total * Math.PI*2;
    const ang1 = ang0 + ang;
    const x0 = cx + r*Math.cos(ang0), y0 = cy + r*Math.sin(ang0);
    const x1 = cx + r*Math.cos(ang1), y1 = cy + r*Math.sin(ang1);
    const large = ang > Math.PI ? 1 : 0;
    const path = document.createElementNS("http://www.w3.org/2000/svg","path");
    path.setAttribute("d", `M ${cx} ${cy} L ${x0} ${y0} A ${r} ${r} 0 ${large} 1 ${x1} ${y1} Z`);
    path.setAttribute("fill", p.color);
    svg.appendChild(path);
    ang0 = ang1;
  });
  // legend
  const legend = document.createElementNS("http://www.w3.org/2000/svg","text");
  legend.setAttribute("x", w/2); legend.setAttribute("y", h-8);
  legend.setAttribute("font-size","12"); legend.setAttribute("text-anchor","middle");
  const pct = ((openCount/total)*100).toFixed(1);
  legend.textContent = `Open ${pct}%`;
  svg.appendChild(legend);
}

function renderRank(table, rows){
  const sorted = rows.slice().sort((a,b)=>{
    // Ranking: Open% asc, then Avg Repair asc, then Avg Response asc, then total desc
    const k1 = (a.open_rate_pct??1e9) - (b.open_rate_pct??1e9);
    const k2 = (a.avg_repair_days??1e9) - (b.avg_repair_days??1e9);
    const k3 = (a.avg_response_days??1e9) - (b.avg_response_days??1e9);
    const k4 = (b.total_wo??0) - (a.total_wo??0);
    return k1 || k2 || k3 || k4;
  });
  const head = ['#','site','total_wo','open_wo','closed_wo','open_rate_pct','avg_response_days','avg_repair_days'];
  table.innerHTML = `<thead><tr>${head.map(h=>`<th>${h}</th>`).join('')}</tr></thead><tbody></tbody>`;
  const tb = table.querySelector('tbody');
  sorted.slice(0,12).forEach((r,i)=>{
    const tr = document.createElement('tr');
    const vals = [i+1, r.site, r.total_wo, r.open_wo, r.closed_wo,
      r.open_rate_pct!=null? r.open_rate_pct.toFixed(1)+'%':'—',
      r.avg_response_days!=null? r.avg_response_days.toFixed(2):'—',
      r.avg_repair_days!=null? r.avg_repair_days.toFixed(2):'—'
    ];
    vals.forEach(v=>{ const td = document.createElement('td'); td.textContent = v; tr.appendChild(td); });
    tb.appendChild(tr);
  });
}

function siteReco(r){
  const openRate = r.open_rate_pct||0;
  const avgRep = r.avg_repair_days||0;
  const avgResp = r.avg_response_days||0;
  const rec = [];
  if(openRate > 30) rec.push("Reduce backlog: daily aging report, assign owners, escalate >7 days.");
  if(avgRep > 5) rec.push("Improve spare parts readiness & vendor SLA; pre-approve common parts.");
  if(avgResp > 2) rec.push("Faster triage/dispatch within 2 hours; ensure on-call coverage.");
  if(!rec.length) rec.push("Good performance. Maintain weekly monitoring.");
  return rec;
}
function renderSites(container, rows){
  container.innerHTML='';
  rows.forEach(r=>{
    const det = document.createElement('details'); det.className='site';
    const sum = document.createElement('summary'); sum.textContent = r.site;
    const body = document.createElement('div'); body.className='site-body';
    const kv = document.createElement('div'); kv.className='kv';
    kv.innerHTML = `
      <div><span>Total WOs</span><b>${r.total_wo}</b></div>
      <div><span>Open WOs</span><b>${r.open_wo} <i class="badge red">Open</i></b></div>
      <div><span>Closed WOs</span><b>${r.closed_wo} <i class="badge green">Closed</i></b></div>
      <div><span>Open %</span><b>${r.open_rate_pct!=null?r.open_rate_pct.toFixed(1)+'%':'—'}</b></div>
      <div><span>Avg. Response (days)</span><b>${r.avg_response_days!=null?r.avg_response_days.toFixed(2):'—'}</b></div>
      <div><span>Avg. Repair (days)</span><b>${r.avg_repair_days!=null?r.avg_repair_days.toFixed(2):'—'}</b></div>
    `;
    const recs = siteReco(r).map(x=>`<li>${x}</li>`).join('');
    body.innerHTML = kv.outerHTML + `<div><b>Recommendations</b><ul>${recs}</ul></div>`;
    det.appendChild(sum); det.appendChild(body);
    container.appendChild(det);
  });
}

function calculateAndRender(CMrows, PMrows){
  // Corrective
  const cm_by_site = groupBySite(CMrows);
  const cm_meta = metricsSummary(cm_by_site, false);
  const cm_top = topDevicesCM(CMrows);

  renderKPIs(document.getElementById('cm-kpis'), cm_meta, false);
  drawBar(document.getElementById('cm-total'), cm_by_site, 'site', 'total_wo');
  drawPie(document.getElementById('cm-pie'), cm_meta.open_wo, cm_meta.closed_wo);
  drawBar(document.getElementById('cm-repair'), cm_by_site, 'site', 'avg_repair_days');
  drawTopDevices(document.getElementById('cm-dev'), cm_top);
  renderRank(document.getElementById('cm-rank'), cm_by_site);
  renderSites(document.getElementById('cm-sites'), cm_by_site);

  // Preventive
  const pm_by_site = groupBySitePM(PMrows);
  const pm_meta = metricsSummary(pm_by_site, true);

  renderKPIs(document.getElementById('pm-kpis'), pm_meta, true);
  drawBar(document.getElementById('pm-total'), pm_by_site, 'site', 'total_wo');
  drawPie(document.getElementById('pm-pie'), pm_meta.open_wo, pm_meta.closed_wo);
  drawBar(document.getElementById('pm-repair'), pm_by_site, 'site', 'avg_repair_days');
  renderRank(document.getElementById('pm-rank'), pm_by_site);
  renderSites(document.getElementById('pm-sites'), pm_by_site);

  // Combined
  const co_by_site = combinedFrom(cm_by_site, pm_by_site);
  const co_meta = metricsSummary(co_by_site, false);

  renderKPIs(document.getElementById('co-kpis'), co_meta, false);
  drawBar(document.getElementById('co-total'), co_by_site, 'site', 'total_wo');
  drawPie(document.getElementById('co-pie'), co_meta.open_wo, co_meta.closed_wo);
  drawBar(document.getElementById('co-repair'), co_by_site, 'site', 'avg_repair_days');
  renderRank(document.getElementById('co-rank'), co_by_site);
  renderSites(document.getElementById('co-sites'), co_by_site);
}

// Top devices bar
function drawTopDevices(svg, rows){
  const w = svg.clientWidth, h = svg.clientHeight, pad=40;
  svg.innerHTML='';
  if(!rows.length){
    const t = document.createElementNS("http://www.w3.org/2000/svg","text");
    t.setAttribute("x", w/2); t.setAttribute("y", h/2);
    t.setAttribute("text-anchor","middle"); t.textContent = "No device breakdown found.";
    svg.appendChild(t); return;
  }
  const max = Math.max(1, ...rows.map(d=>d.count||0));
  const barW = (w - pad*2) / rows.length;
  const axis = document.createElementNS("http://www.w3.org/2000/svg", "line");
  axis.setAttribute("x1", pad); axis.setAttribute("y1", h-pad);
  axis.setAttribute("x2", w-pad); axis.setAttribute("y2", h-pad);
  axis.setAttribute("stroke", "#9ca3af"); axis.setAttribute("stroke-width", "1");
  svg.appendChild(axis);
  rows.forEach((d,i)=>{
    const x = pad + i*barW + 5;
    const y = h - pad - ( (d.count||0)/max * (h-pad*2) );
    const rect = document.createElementNS("http://www.w3.org/2000/svg","rect");
    rect.setAttribute("x", x); rect.setAttribute("y", y);
    rect.setAttribute("width", Math.max(2, barW-10));
    rect.setAttribute("height", (h-pad) - y);
    rect.setAttribute("fill", "#60a5fa");
    svg.appendChild(rect);
    const label = document.createElementNS("http://www.w3.org/2000/svg","text");
    label.setAttribute("x", x + (barW-10)/2);
    label.setAttribute("y", h-10);
    label.setAttribute("font-size","10");
    label.setAttribute("text-anchor","middle");
    label.textContent = String(d.device).slice(0,12);
    svg.appendChild(label);
  });
}
</script>
</body>
</html>
