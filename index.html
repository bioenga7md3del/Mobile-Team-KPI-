<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„ÙˆØ­Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙŠØ§Ù†Ø© (WO & PPM & Combined)</title>

  <!-- Chart.js & SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    *{box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
    body{margin:0;background:#f5f7fa;color:#333}
    .wrap{max-width:1400px;margin:0 auto;padding:16px}
    header{background:#fff;border-radius:14px;padding:16px 20px;box-shadow:0 6px 16px rgba(0,0,0,.06);display:flex;gap:16px;align-items:center;margin-bottom:16px}
    header img{height:56px}
    .titles{flex:1}
    h1{margin:0;font-size:1.6rem;color:#2c3e50}
    .credit{margin-top:6px;color:#5a6b85;font-size:.95rem}
    .tabs{display:flex;gap:8px;margin:10px 0 16px;flex-wrap:wrap}
    .tab-btn{border:1px solid #d8dee9;background:#fff;border-radius:10px;padding:10px 14px;cursor:pointer}
    .tab-btn.active{background:#2c3e50;color:#fff;border-color:#2c3e50}
    .card{background:#fff;border-radius:12px;padding:16px;box-shadow:0 6px 16px rgba(0,0,0,.06);margin-bottom:16px}
    .card h2{margin:0 0 10px;font-size:1.1rem;color:#2c3e50;border-bottom:2px solid #f0f2f5;padding-bottom:8px}
    .uploader{display:flex;gap:10px;flex-wrap:wrap;margin:6px 0 8px}
    .pill{display:inline-flex;align-items:center;gap:8px;background:#eef2f7;border:1px dashed #cdd6e1;border-radius:999px;padding:8px 12px;cursor:pointer}
    .pill input{display:none}
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
    .stat{background:#fff;border-radius:10px;padding:12px;border-top:4px solid #4a6491;box-shadow:0 4px 12px rgba(0,0,0,.05)}
    .stat.good{border-top-color:#28a745}.stat.warn{border-top-color:#ffc107}.stat.bad{border-top-color:#dc3545}
    .stat .v{font-size:1.4rem;font-weight:700}
    .filters{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    .filters select{padding:10px 12px;border:1px solid #d8dee9;border-radius:10px;min-width:200px;background:#fff}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:16px}
    .row-two{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
    .chart-box{height:320px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid #edf0f5;text-align:right}
    th{background:#f7f9fc;color:#2c3e50}
    tr:hover{background:#f5f7fa}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:.8rem;font-weight:700}
    .b-ok{background:#d4edda;color:#155724}.b-warn{background:#fff3cd;color:#856404}.b-bad{background:#f8d7da;color:#721c24}
    .progress{height:10px;background:#e9ecef;border-radius:6px;overflow:hidden}
    .progress .fill{height:100%;background:#28a745}
    footer{color:#6b7280;text-align:center;margin:10px 0 20px}
    .hidden{display:none}
    .hint{color:#6b7280;font-size:.9rem}
  </style>
</head>
<body>
<div class="wrap">
  <!-- Header -->
  <header>
    <img src="TabukCluster.jpeg" alt="Tabuk Health Cluster"/>
    <div class="titles">
      <h1>Ù„ÙˆØ­Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙŠØ§Ù†Ø© â€” ØªØµØ­ÙŠØ­ÙŠØ© (WO) ÙˆÙˆÙ‚Ø§Ø¦ÙŠØ© (PPM) ÙˆÙ…Ø¬Ù…Ù‘Ø¹Ø©</h1>
      <div class="credit">ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ù…Ø¯ÙŠØ± Ù…ÙˆÙ‚Ø¹ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ù…ØªØ­Ø±Ùƒ Ù…. Ø£Ø­Ù…Ø¯ Ø¹Ø§Ø¯Ù„</div>
    </div>
  </header>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="wo">WO â€” Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„ØªØµØ­ÙŠØ­ÙŠØ©</button>
    <button class="tab-btn" data-tab="ppm">PPM â€” Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„ÙˆÙ‚Ø§Ø¦ÙŠØ©</button>
    <button class="tab-btn" data-tab="combined">Ù…Ø¬Ù…Ù‘Ø¹Ø©</button>
  </div>

  <!-- WO TAB -->
  <section id="tab-wo">
    <div class="card">
      <h2>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (WO)</h2>
      <div class="uploader">
        <label class="pill">ğŸ“„ Ø±ÙØ¹ Ù…Ù„Ù Wo.xlsx
          <input type="file" id="woFile" accept=".xlsx,.xls"/>
        </label>
        <span id="woHint" class="hint">ğŸ’¡ Ø§Ø±ÙØ¹ Ù…Ù„Ù WO Ù„ÙŠØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ ÙƒÙ„ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</span>
      </div>
      <div class="stats">
        <div class="stat"><div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙˆØ§Ù…Ø±</div><div id="wo-total" class="v">-</div></div>
        <div class="stat good"><div>Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©</div><div id="wo-done" class="v">-</div><div id="wo-donep" class="hint"></div></div>
        <div class="stat warn"><div>ØªØ­Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­</div><div id="wo-pend" class="v">-</div><div id="wo-pendp" class="hint"></div></div>
        <div class="stat"><div>Ø¹Ø¯Ø¯ Ø§Ù„ÙÙ†ÙŠÙŠÙ†</div><div id="wo-techs" class="v">-</div></div>
        <div class="stat"><div>Avg Response KPI</div><div id="wo-resp" class="v">-</div><div class="hint">&lt; 1 ÙŠÙˆÙ…</div></div>
        <div class="stat"><div>Avg Repair KPI</div><div id="wo-rep" class="v">-</div><div class="hint">&lt; 5 Ø£ÙŠØ§Ù…</div></div>
      </div>
      <div class="progress" style="margin-top:8px"><div id="wo-rate" class="fill" style="width:0%"></div></div>
      <div class="hint" style="text-align:left;margin-top:6px">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</div>
    </div>

    <div class="card">
      <h2>Ø§Ù„ÙÙ„Ø§ØªØ±</h2>
      <div class="filters">
        <select id="wo-tech-filter"><option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ†ÙŠÙŠÙ† (Assigned To)</option></select>
        <select id="wo-status-filter">
          <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
          <option value="completed">Ù…Ù†ØªÙ‡ÙŠ</option>
          <option value="pending">ØªØ­Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­</option>
        </select>
        <select id="wo-dept-filter"><option value="">ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§ÙƒØ² (Department)</option></select>
      </div>
    </div>

    <!-- Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„: ØªÙˆØ²ÙŠØ¹ + Ù…ØªÙˆØ³Ø·Ø§Øª -->
    <div class="row-two">
      <div class="card"><h2>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£ÙˆØ§Ù…Ø± (Ù…Ù†ØªÙ‡ÙŠ/ØªØ­Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­)</h2><div class="chart-box"><canvas id="wo-status"></canvas></div></div>
      <div class="card"><h2>Ù…ØªÙˆØ³Ø· Response/Repair Ù„ÙƒÙ„ ÙÙ†ÙŠ</h2><div class="chart-box"><canvas id="wo-bars"></canvas></div></div>
    </div>

    <!-- Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø£Ø¬Ù‡Ø²Ø© + Ù…Ø±Ø§ÙƒØ² -->
    <div class="row-two">
      <div class="card"><h2>Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø£ÙƒØ«Ø± ØªØ¹Ø·Ù‘Ù„Ù‹Ø§ (WO ÙÙ‚Ø·)</h2><div class="chart-box"><canvas id="wo-devices"></canvas></div></div>
      <div class="card"><h2>Ø£ÙƒØ«Ø± Ø§Ù„Ù…Ø±Ø§ÙƒØ² Ø§Ù„ØµØ­ÙŠØ© ØªØ¹Ø·Ù‘Ù„Ù‹Ø§ (Department)</h2><div class="chart-box"><canvas id="wo-depts"></canvas></div></div>
    </div>

    <div class="card">
      <h2>Ø¬Ø¯ÙˆÙ„ Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙÙ†ÙŠÙŠÙ† (WO)</h2>
      <table id="wo-tech-table">
        <thead>
          <tr>
            <th>Ø§Ù„ÙÙ†ÙŠ</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ù…Ù†ØªÙ‡ÙŠ</th><th>ØªØ­Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­</th>
            <th>Avg Response</th><th>Avg Repair</th><th>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <h2 id="wo-pending-title">Ø§Ù„Ø£ÙˆØ§Ù…Ø± ØªØ­Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­</h2>
      <table id="wo-pending">
        <thead>
          <tr><th>Ø±Ù‚Ù…</th><th>Assigned To</th><th>Department</th><th>Ø§Ù„Ø¬Ù‡Ø§Ø²</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- PPM TAB -->
  <section id="tab-ppm" class="hidden">
    <div class="card">
      <h2>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (PPM)</h2>
      <div class="uploader">
        <label class="pill">ğŸ“„ Ø±ÙØ¹ Ù…Ù„Ù ppm.xlsx
          <input type="file" id="ppmFile" accept=".xlsx,.xls"/>
        </label>
        <span id="ppmHint" class="hint">ğŸ’¡ Ø§Ø±ÙØ¹ Ù…Ù„Ù PPM Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª.</span>
      </div>
      <div class="stats">
        <div class="stat"><div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‡Ø§Ù…</div><div id="ppm-total" class="v">-</div></div>
        <div class="stat good"><div>Ù…Ù†Ø¬Ø²</div><div id="ppm-done" class="v">-</div><div id="ppm-donep" class="hint"></div></div>
        <div class="stat warn"><div>ØºÙŠØ± Ù…Ù†Ø¬Ø²</div><div id="ppm-pend" class="v">-</div><div id="ppm-pendp" class="hint"></div></div>
        <div class="stat"><div>Ø¹Ø¯Ø¯ Ø§Ù„ÙÙ†ÙŠÙŠÙ†</div><div id="ppm-techs" class="v">-</div></div>
        <div class="stat"><div>Avg Response KPI</div><div id="ppm-resp" class="v">-</div><div class="hint">&lt; 15 ÙŠÙˆÙ…</div></div>
        <div class="stat"><div>Avg Repair KPI</div><div id="ppm-rep" class="v">-</div><div class="hint">&lt; 30 ÙŠÙˆÙ…</div></div>
      </div>
      <div class="progress" style="margin-top:8px"><div id="ppm-rate" class="fill" style="width:0%"></div></div>
      <div class="hint" style="text-align:left;margin-top:6px">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² (PPM)</div>
    </div>

    <div class="card">
      <h2>Ø§Ù„ÙÙ„Ø§ØªØ±</h2>
      <div class="filters">
        <select id="ppm-tech-filter"><option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ†ÙŠÙŠÙ† (Assigned To)</option></select>
        <select id="ppm-status-filter">
          <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
          <option value="completed">Ù…Ù†Ø¬Ø²</option>
          <option value="pending">ØºÙŠØ± Ù…Ù†Ø¬Ø²</option>
        </select>
        <select id="ppm-dept-filter"><option value="">ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§ÙƒØ² (Department)</option></select>
      </div>
    </div>

    <div class="row-two">
      <div class="card"><h2>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª (Ù…Ù†Ø¬Ø²/ØºÙŠØ± Ù…Ù†Ø¬Ø²)</h2><div class="chart-box"><canvas id="ppm-status"></canvas></div></div>
      <div class="card"><h2>Ù…ØªÙˆØ³Ø· Response/Repair Ù„ÙƒÙ„ ÙÙ†ÙŠ</h2><div class="chart-box"><canvas id="ppm-bars"></canvas></div></div>
    </div>

    <div class="card">
      <h2>Ø§Ù„Ù…Ø±Ø§ÙƒØ² Ø§Ù„ØµØ­ÙŠØ© (Department)</h2>
      <div class="chart-box"><canvas id="ppm-depts"></canvas></div>
    </div>

    <div class="card">
      <h2>Ø¬Ø¯ÙˆÙ„ Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙÙ†ÙŠÙŠÙ† (PPM)</h2>
      <table id="ppm-tech-table">
        <thead>
          <tr>
            <th>Ø§Ù„ÙÙ†ÙŠ</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ù…Ù†Ø¬Ø²</th><th>ØºÙŠØ± Ù…Ù†Ø¬Ø²</th>
            <th>Avg Response</th><th>Avg Repair</th><th>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <h2 id="ppm-pending-title">Ø§Ù„Ù…Ù‡Ø§Ù… ØºÙŠØ± Ø§Ù„Ù…Ù†Ø¬Ø²Ø©</h2>
      <table id="ppm-pending">
        <thead>
          <tr><th>Ø±Ù‚Ù…</th><th>Assigned To</th><th>Department</th><th>Ø§Ù„Ø¬Ù‡Ø§Ø²</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- COMBINED TAB -->
  <section id="tab-combined" class="hidden">
    <div class="card">
      <h2>Ø¬Ø¯ÙˆÙ„ Ù…Ø¬Ù…Ù‘Ø¹ (WO + PPM)</h2>
      <div class="hint" style="margin-bottom:8px">Ø§Ù„ÙØ±Ø²: Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² â†“ ØŒ Ø«Ù… Avg Repair â†‘ ØŒ Ø«Ù… Avg Response â†‘ ØŒ Ø«Ù… Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙˆØ§Ù…Ø± â†“</div>
      <table id="combined-table">
        <thead>
          <tr>
            <th>Ø§Ù„ÙÙ†ÙŠ</th>
            <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙˆØ§Ù…Ø± (WO+PPM)</th>
            <th>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² Ù…Ø¬Ù…Ù‘Ø¹</th>
            <th>Avg Repair (WO+PPM)</th>
            <th>Avg Response (WO+PPM)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="hint" id="combined-hint" style="margin-top:8px"></div>
    </div>
  </section>

  <footer>Ù„ÙˆØ­Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙŠØ§Ù†Ø© â€” Tabuk Health Cluster â€¢ 2025</footer>
</div>

<script>
/* ===== Utilities & Aliases ===== */
const isEmptyDate = (v) => v==null || String(v).trim()==='';
const toNum = (v)=>{ if(v==null||v==='') return null; const n=Number(String(v).replace(',','.')); return isNaN(n)? null : n; };
const pick = (row, candidates)=>{
  const map=Object.fromEntries(Object.keys(row).map(k=>[k.toLowerCase().trim(),k]));
  for(const c of candidates){ const key=Object.keys(map).find(x=>x===c || x.includes(c)); if(key) return map[key]; }
  return null;
};

const COL = {
  assigned: ['assigned to','technician','Ø§Ù„ÙÙ†ÙŠ'],
  respKPI:  ['respose kpi','response kpi','response','avg response'],
  repKPI:   ['repierd kpi','repaired kpi','repair kpi','repair','avg repair'],
  signoff:  ['sign off date','sign-off date','sign off','ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØºÙ„Ø§Ù‚','ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù‚ÙØ§Ù„','signoff'],
  dept:     ['department','Ø§Ù„Ù‚Ø³Ù…','site/department','site','Ø§Ù„Ù…ÙˆÙ‚Ø¹'],
  device:   ['device','equipment','Ø§Ù„Ø¬Ù‡Ø§Ø²','ecri','equipment name','asset']
};

async function parseExcel(file){
  return new Promise((resolve,reject)=>{
    const r=new FileReader();
    r.onload=(e)=>{ resolve(parseExcelBuffer(e.target.result)); };
    r.onerror=reject;
    r.readAsArrayBuffer(file);
  });
}

// Ù‚Ø±Ø§Ø¡Ø© Ù…Ù† ArrayBuffer Ù…Ø¨Ø§Ø´Ø±Ø© (Ù„Ù„Ø§ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒ)
async function parseExcelBuffer(arrayBuffer){
  const wb=XLSX.read(new Uint8Array(arrayBuffer),{type:'array'});
  const ws=wb.Sheets[wb.SheetNames[0]];
  const arr=XLSX.utils.sheet_to_json(ws,{defval:''});
  if(!arr.length) return [];
  const c={
    assigned: pick(arr[0], COL.assigned),
    respKPI:  pick(arr[0], COL.respKPI),
    repKPI:   pick(arr[0], COL.repKPI),
    signoff:  pick(arr[0], COL.signoff),
    dept:     pick(arr[0], COL.dept),
    device:   pick(arr[0], COL.device)
  };
  return arr.map((r,i)=>({
    idx:i+1,
    assigned:c.assigned? r[c.assigned]:'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
    resp:    c.respKPI ? toNum(r[c.respKPI]) : null,
    rep:     c.repKPI  ? toNum(r[c.repKPI])  : null,
    status:  c.signoff ? (isEmptyDate(r[c.signoff])?'pending':'completed') : (r['status']?.toLowerCase?.().includes('comp')?'completed':'pending'),
    dept:    c.dept? r[c.dept]:'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
    device:  c.device? r[c.device]:'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'
  }));
}

function avg(arr){ return arr.length? +(arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(2) : null; }

/* ===== Targets Coloring ===== */
function colorByTarget(val, target){
  if(val==null) return {text:'-', cls:''};
  if(val < target.ok)   return {text:val, cls:'b-ok'};
  if(val < target.warn) return {text:val, cls:'b-warn'};
  return {text:val, cls:'b-bad'};
}
const TARGETS = {
  WO:   { response:{ok:1,  warn:1},  repair:{ok:5,  warn:5}  }, // <1 / <5
  PPM:  { response:{ok:15, warn:15}, repair:{ok:30, warn:30} }  // <15 / <30
};

/* ===== Aggregation (generic) ===== */
function aggregate(rows, filters){
  const fTech=filters.tech||'', fStatus=filters.status||'', fDept=filters.dept||'';
  const filtered=rows.filter(r=>{
    const okT=!fTech || String(r.assigned)===fTech;
    const okS=!fStatus || r.status===fStatus;
    const okD=!fDept || String(r.dept)===fDept;
    return okT&&okS&&okD;
  });
  // by tech
  const tmap=new Map();
  filtered.forEach(r=>{
    if(!tmap.has(r.assigned)) tmap.set(r.assigned,{name:r.assigned,total:0,done:0,pend:0,rs:[],rp:[]});
    const t=tmap.get(r.assigned);
    t.total++; (r.status==='completed')? t.done++ : t.pend++;
    if(r.resp!=null) t.rs.push(r.resp);
    if(r.rep!=null)  t.rp.push(r.rep);
  });
  const byTech=Array.from(tmap.values()).map(t=>({
    name:t.name,total:t.total,done:t.done,pend:t.pend,
    resp:avg(t.rs), rep:avg(t.rp)
  })).sort((a,b)=> b.total-a.total);

  // by device
  const devMap=new Map();
  filtered.forEach(r=> devMap.set(r.device,(devMap.get(r.device)||0)+1));
  const byDevice=Array.from(devMap.entries()).map(([name,count])=>({name,count}))
                      .sort((a,b)=> b.count-a.count).slice(0,15);

  // by dept
  const dmap=new Map();
  filtered.forEach(r=> dmap.set(r.dept,(dmap.get(r.dept)||0)+1));
  const byDept=Array.from(dmap.entries()).map(([name,count])=>({name,count}))
                    .sort((a,b)=> b.count-a.count).slice(0,15);

  const total=filtered.length, done=filtered.filter(r=>r.status==='completed').length;
  const pend=total-done, rate= total? Math.round(done*1000/total)/10 : 0;

  const pendingRows=filtered.filter(r=>r.status==='pending');
  const techs=Array.from(new Set(rows.map(r=>r.assigned))).sort((a,b)=> a.localeCompare(b,'ar'));
  const depts=Array.from(new Set(rows.map(r=>r.dept))).sort((a,b)=> a.localeCompare(b,'ar'));
  return {filtered,byTech,byDevice,byDept,total,done,pend,rate,pendingRows,techs,depts};
}

/* ===== Charts helpers ===== */
const charts={};
function drawDoughnut(id,labels,data){
  if(charts[id]) charts[id].destroy();
  charts[id]=new Chart(document.getElementById(id).getContext('2d'),{
    type:'doughnut',
    data:{labels,datasets:[{data,borderWidth:1,backgroundColor:['#28a745','#ffc107','#36b9cc','#4e73df','#e74a3b']}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',rtl:true}}}
  });
}
function drawBars(id,labels,ds){
  if(charts[id]) charts[id].destroy();
  charts[id]=new Chart(document.getElementById(id).getContext('2d'),{
    type:'bar',
    data:{labels,datasets:ds},
    options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}
  });
}

/* ===== WO state ===== */
let WO_ROWS=[];
function refreshWO(){
  const filters={tech:woTech.value,status:woStatus.value,dept:woDept.value};
  const A=aggregate(WO_ROWS,filters);

  // Fill selects once
  if(woTech.options.length<=1) A.techs.forEach(t=> woTech.insertAdjacentHTML('beforeend',`<option>${t}</option>`));
  if(woDept.options.length<=1) A.depts.forEach(d=> woDept.insertAdjacentHTML('beforeend',`<option>${d}</option>`));

  woTotal.textContent=A.total; woDone.textContent=A.done; woPend.textContent=A.pend;
  woDoneP.textContent=`${A.rate}% Ù…Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ`; woPendP.textContent=`${(100-A.rate).toFixed(1)}% Ù…Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ`;
  woTechs.textContent=new Set(A.filtered.map(r=>r.assigned)).size;
  woRate.style.width=`${A.rate}%`;

  const respAll=A.filtered.map(r=>r.resp).filter(x=>x!=null);
  const repAll=A.filtered.map(r=>r.rep).filter(x=>x!=null);
  const respAvg=avg(respAll)||0, repAvg=avg(repAll)||0;
  const rCol=colorByTarget(respAvg, TARGETS.WO.response);
  const fCol=colorByTarget(repAvg,  TARGETS.WO.repair);
  woResp.innerHTML=`<span class="badge ${rCol.cls}">${rCol.text}</span>`;
  woRep.innerHTML =`<span class="badge ${fCol.cls}">${fCol.text}</span>`;

  drawDoughnut('wo-status',[`Ù…Ù†ØªÙ‡ÙŠ (${A.done})`,`ØªØ­Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­ (${A.pend})`],[A.done,A.pend]);
  drawBars('wo-bars', A.byTech.map(t=>t.name), [
    {label:'Avg Response', data:A.byTech.map(t=>t.resp??0), borderWidth:1, backgroundColor:'rgba(54,162,235,.7)'},
    {label:'Avg Repair',   data:A.byTech.map(t=>t.rep??0),  borderWidth:1, backgroundColor:'rgba(255,99,132,.7)'}
  ]);
  drawDoughnut('wo-devices', A.byDevice.map(d=>d.name), A.byDevice.map(d=>d.count));
  drawBars('wo-depts', A.byDept.map(d=>d.name), [{label:'WO count', data:A.byDept.map(d=>d.count), borderWidth:1, backgroundColor:'rgba(75,192,192,.7)'}]);

  const tb=document.querySelector('#wo-tech-table tbody'); tb.innerHTML='';
  A.byTech.forEach(t=>{
    const rCol=colorByTarget(t.resp, TARGETS.WO.response);
    const fCol=colorByTarget(t.rep,  TARGETS.WO.repair);
    tb.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${t.name}</td><td>${t.total}</td><td>${t.done}</td><td>${t.pend}</td>
        <td><span class="badge ${rCol.cls}">${rCol.text}</span></td>
        <td><span class="badge ${fCol.cls}">${fCol.text}</span></td>
        <td>${rankBadge(t.resp,t.rep)}</td>
      </tr>`);
  });

  const pb=document.querySelector('#wo-pending tbody'); pb.innerHTML='';
  document.getElementById('wo-pending-title').textContent=`Ø§Ù„Ø£ÙˆØ§Ù…Ø± ØªØ­Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­ (${A.pend})`;
  A.pendingRows.forEach(r=>{
    pb.insertAdjacentHTML('beforeend',`<tr><td>${r.idx}</td><td>${r.assigned}</td><td>${r.dept}</td><td>${r.device}</td><td>Sign-off ÙØ§Ø±Øº</td></tr>`);
  });

  refreshCombinedHint(); // Ù„ØªÙˆØ¶ÙŠØ­ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ù…Ø¬
}

function rankBadge(resp,rep){
  const r=resp??9e9, f=rep??9e9;
  if(r<1 && f<5) return '<span class="badge b-ok">Ù…Ù…ØªØ§Ø²</span>';
  if(r<2.5 && f<3.5) return '<span class="badge b-ok">Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹</span>';
  if(r<3.5 && f<5) return '<span class="badge b-warn">Ù…ØªÙˆØ³Ø·</span>';
  if(r<5.5 && f<7.5) return '<span class="badge b-warn">ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†</span>';
  return '<span class="badge b-bad">Ø¶Ø¹ÙŠÙ</span>';
}

/* ===== PPM state ===== */
let PPM_ROWS=[];
function refreshPPM(){
  const filters={tech:ppmTech.value,status:ppmStatus.value,dept:ppmDept.value};
  const A=aggregate(PPM_ROWS,filters);

  if(ppmTech.options.length<=1) A.techs.forEach(t=> ppmTech.insertAdjacentHTML('beforeend',`<option>${t}</option>`));
  if(ppmDept.options.length<=1) A.depts.forEach(d=> ppmDept.insertAdjacentHTML('beforeend',`<option>${d}</option>`));

  ppmTotal.textContent=A.total; ppmDone.textContent=A.done; ppmPend.textContent=A.pend;
  ppmDoneP.textContent=`${A.rate}% Ù…Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ`; ppmPendP.textContent=`${(100-A.rate).toFixed(1)}% Ù…Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ`;
  ppmTechs.textContent=new Set(A.filtered.map(r=>r.assigned)).size;
  ppmRate.style.width=`${A.rate}%`;

  const respAll=A.filtered.map(r=>r.resp).filter(x=>x!=null);
  const repAll=A.filtered.map(r=>r.rep).filter(x=>x!=null);
  const respAvg=avg(respAll)||0, repAvg=avg(repAll)||0;
  const rCol=colorByTarget(respAvg, TARGETS.PPM.response);
  const fCol=colorByTarget(repAvg,  TARGETS.PPM.repair);
  ppmResp.innerHTML=`<span class="badge ${rCol.cls}">${rCol.text}</span>`;
  ppmRep.innerHTML =`<span class="badge ${fCol.cls}">${fCol.text}</span>`;

  drawDoughnut('ppm-status',[`Ù…Ù†Ø¬Ø² (${A.done})`,`ØºÙŠØ± Ù…Ù†Ø¬Ø² (${A.pend})`],[A.done,A.pend]);
  drawBars('ppm-bars', A.byTech.map(t=>t.name), [
    {label:'Avg Response', data:A.byTech.map(t=>t.resp??0), borderWidth:1, backgroundColor:'rgba(54,162,235,.7)'},
    {label:'Avg Repair',   data:A.byTech.map(t=>t.rep??0),  borderWidth:1, backgroundColor:'rgba(255,159,64,.7)'}
  ]);
  drawBars('ppm-depts', A.byDept.map(d=>d.name), [{label:'PPM count', data:A.byDept.map(d=>d.count), borderWidth:1, backgroundColor:'rgba(75,192,192,.7)'}]);

  const tb=document.querySelector('#ppm-tech-table tbody'); tb.innerHTML='';
  A.byTech.forEach(t=>{
    const rCol=colorByTarget(t.resp, TARGETS.PPM.response);
    const fCol=colorByTarget(t.rep,  TARGETS.PPM.repair);
    tb.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${t.name}</td><td>${t.total}</td><td>${t.done}</td><td>${t.pend}</td>
        <td><span class="badge ${rCol.cls}">${rCol.text}</span></td>
        <td><span class="badge ${fCol.cls}">${fCol.text}</span></td>
        <td>${rankBadgePPM(t.resp,t.rep)}</td>
      </tr>`);
  });

  const pb=document.querySelector('#ppm-pending tbody'); pb.innerHTML='';
  document.getElementById('ppm-pending-title').textContent=`ØºÙŠØ± Ø§Ù„Ù…Ù†Ø¬Ø²Ø© (${A.pend})`;
  A.pendingRows.forEach(r=>{
    pb.insertAdjacentHTML('beforeend',`<tr><td>${r.idx}</td><td>${r.assigned}</td><td>${r.dept}</td><td>${r.device}</td><td>Sign-off ÙØ§Ø±Øº</td></tr>`);
  });

  refreshCombinedHint();
}

function rankBadgePPM(resp,rep){
  const r=resp??9e9, f=rep??9e9;
  if(r<15 && f<30) return '<span class="badge b-ok">Ø¶Ù…Ù† Ø§Ù„Ù‡Ø¯Ù</span>';
  if(r<20 && f<40) return '<span class="badge b-warn">Ù‚Ø±ÙŠØ¨ Ù…Ù† Ø§Ù„Ù‡Ø¯Ù</span>';
  return '<span class="badge b-bad">Ø¨Ø¹ÙŠØ¯ Ø¹Ù† Ø§Ù„Ù‡Ø¯Ù</span>';
}

/* ===== Combined ===== */
function buildCombined(){
  const map=new Map();
  function ingest(rows){
    rows.forEach(r=>{
      if(!map.has(r.assigned)) map.set(r.assigned,{name:r.assigned,total:0,done:0,rs:[],rp:[]});
      const t=map.get(r.assigned);
      t.total++;
      if(r.status==='completed') t.done++;
      if(r.resp!=null) t.rs.push(r.resp);
      if(r.rep!=null)  t.rp.push(r.rep);
    });
  }
  ingest(WO_ROWS);
  ingest(PPM_ROWS);

  const list=Array.from(map.values()).map(t=>({
    name:t.name,
    total:t.total,
    rate: t.total? +(t.done*100/t.total).toFixed(1) : 0,
    avgRepair: avg(t.rp) ?? null,
    avgResp:   avg(t.rs) ?? null
  }));

  // Ø§Ù„ÙØ±Ø²: Ø¥Ù†Ø¬Ø§Ø² â†“ ØŒ Ø¥ØµÙ„Ø§Ø­ â†‘ ØŒ Ø§Ø³ØªØ¬Ø§Ø¨Ø© â†‘ ØŒ Ø¥Ø¬Ù…Ø§Ù„ÙŠ â†“
  list.sort((a,b)=>{
    if(b.rate!==a.rate) return b.rate - a.rate;
    if((a.avgRepair??1e9)!==(b.avgRepair??1e9)) return (a.avgRepair??1e9) - (b.avgRepair??1e9);
    if((a.avgResp??1e9)!==(b.avgResp??1e9))     return (a.avgResp??1e9)   - (b.avgResp??1e9);
    return (b.total - a.total);
  });

  const tb=document.querySelector('#combined-table tbody'); tb.innerHTML='';
  list.forEach(t=>{
    const rBadge = `<span class="badge ${t.avgRepair!=null ? (t.avgRepair<5?'b-ok':'b-bad') : ''}">${t.avgRepair ?? '-'}</span>`;
    const sBadge = `<span class="badge ${t.avgResp!=null   ? (t.avgResp  <1?'b-ok':'b-bad')   : ''}">${t.avgResp ?? '-'}</span>`;
    tb.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${t.name}</td>
        <td>${t.total}</td>
        <td>${t.rate}%</td>
        <td>${rBadge}</td>
        <td>${sBadge}</td>
      </tr>`);
  });
}

function refreshCombinedHint(){
  const hint=document.getElementById('combined-hint');
  if(!WO_ROWS.length && !PPM_ROWS.length) hint.textContent='Ù„Ù… ÙŠØªÙ… Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Ø¨Ø¹Ø¯.';
  else if(WO_ROWS.length && !PPM_ROWS.length) hint.textContent='ØªÙ… Ø§Ù„ØªØ¬Ù…ÙŠØ¹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ WO ÙÙ‚Ø· (Ù„Ù… ÙŠØªÙ… Ø±ÙØ¹ PPM).';
  else if(!WO_ROWS.length && PPM_ROWS.length) hint.textContent='ØªÙ… Ø§Ù„ØªØ¬Ù…ÙŠØ¹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ PPM ÙÙ‚Ø· (Ù„Ù… ÙŠØªÙ… Ø±ÙØ¹ WO).';
  else hint.textContent='ØªÙ… Ø§Ù„ØªØ¬Ù…ÙŠØ¹ Ù…Ù† WO Ùˆ PPM.';
}

/* ===== Auto-load from repo (data/Wo.xlsx & data/ppm.xlsx) ===== */
async function tryAutoLoadExcel(path){
  try{
    const res = await fetch(path, { cache: 'no-store' });
    if(!res.ok) return null;
    const buf = await res.arrayBuffer();
    return parseExcelBuffer(buf);
  }catch(e){ return null; }
}

async function autoInitFromRepo(){
  const wo = await tryAutoLoadExcel('data/Wo.xlsx');
  if(wo && Array.isArray(wo) && wo.length){
    WO_ROWS = wo;
    document.getElementById('woHint').textContent = 'âœ” ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† data/Wo.xlsx';
    document.getElementById('wo-tech-filter').innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ†ÙŠÙŠÙ† (Assigned To)</option>';
    document.getElementById('wo-dept-filter').innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§ÙƒØ² (Department)</option>';
    refreshWO();
  }

  const ppm = await tryAutoLoadExcel('data/ppm.xlsx');
  if(ppm && Array.isArray(ppm) && ppm.length){
    PPM_ROWS = ppm;
    document.getElementById('ppmHint').textContent = 'âœ” ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† data/ppm.xlsx';
    document.getElementById('ppm-tech-filter').innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ†ÙŠÙŠÙ† (Assigned To)</option>';
    document.getElementById('ppm-dept-filter').innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§ÙƒØ² (Department)</option>';
    refreshPPM();
  }

  refreshCombinedHint();
}

/* ===== Wiring ===== */
const woTech=document.getElementById('wo-tech-filter');
const woStatus=document.getElementById('wo-status-filter');
const woDept=document.getElementById('wo-dept-filter');

const ppmTech=document.getElementById('ppm-tech-filter');
const ppmStatus=document.getElementById('ppm-status-filter');
const ppmDept=document.getElementById('ppm-dept-filter');

const woTotal=document.getElementById('wo-total');
const woDone=document.getElementById('wo-done');
const woPend=document.getElementById('wo-pend');
const woDoneP=document.getElementById('wo-donep');
const woPendP=document.getElementById('wo-pendp');
const woTechs=document.getElementById('wo-techs');
const woResp=document.getElementById('wo-resp');
const woRep=document.getElementById('wo-rep');
const woRate=document.getElementById('wo-rate');

const ppmTotal=document.getElementById('ppm-total');
const ppmDone=document.getElementById('ppm-done');
const ppmPend=document.getElementById('ppm-pend');
const ppmDoneP=document.getElementById('ppm-donep');
const ppmPendP=document.getElementById('ppm-pendp');
const ppmTechs=document.getElementById('ppm-techs');
const ppmResp=document.getElementById('ppm-resp');
const ppmRep=document.getElementById('ppm-rep');
const ppmRate=document.getElementById('ppm-rate');

// Tabs switching
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tab=btn.dataset.tab;
    document.getElementById('tab-wo').classList.toggle('hidden', tab!=='wo');
    document.getElementById('tab-ppm').classList.toggle('hidden', tab!=='ppm');
    document.getElementById('tab-combined').classList.toggle('hidden', tab!=='combined');
    if(tab==='combined') buildCombined();
  });
});

['wo-tech-filter','wo-status-filter','wo-dept-filter'].forEach(id=> document.getElementById(id).addEventListener('change', refreshWO));
['ppm-tech-filter','ppm-status-filter','ppm-dept-filter'].forEach(id=> document.getElementById(id).addEventListener('change', refreshPPM));

document.getElementById('woFile').addEventListener('change', async (e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  WO_ROWS=await parseExcel(f);
  document.getElementById('woHint').textContent=`âœ” ØªÙ… ØªØ­Ù…ÙŠÙ„: ${f.name}`;
  woTech.innerHTML='<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ†ÙŠÙŠÙ† (Assigned To)</option>';
  woDept.innerHTML='<option value="">ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§ÙƒØ² (Department)</option>';
  refreshWO();
});

document.getElementById('ppmFile').addEventListener('change', async (e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  PPM_ROWS=await parseExcel(f);
  document.getElementById('ppmHint').textContent=`âœ” ØªÙ… ØªØ­Ù…ÙŠÙ„: ${f.name}`;
  ppmTech.innerHTML='<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ†ÙŠÙŠÙ† (Assigned To)</option>';
  ppmDept.innerHTML='<option value="">ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§ÙƒØ² (Department)</option>';
  refreshPPM();
});

// ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© (GitHub Pages)
window.addEventListener('DOMContentLoaded', autoInitFromRepo);
</script>
</body>
</html>
