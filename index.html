<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Mobile Team Monthly Maintenance KPIs ‚Äì October 2025</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net"/>
<link rel="dns-prefetch" href="https://cdn.jsdelivr.net"/>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
:root{
  --bg:#f7f7fb; --panel:#ffffff; --muted:#6b7280; --text:#1f2937; --border:#e5e7eb;
  --ring:#d1d5db; --shadow:0 10px 30px rgba(0,0,0,.05);
  --gold:#ffedd5; --gold-border:#fbbf24; --gold-text:#b45309;
  --green:#10b981; --red:#ef4444; --orange:#f59e0b; --subtle:#f3f4f6;
}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial}
.container{max-width:1200px;margin:22px auto;padding:0 12px}

/* header */
.header{display:grid;grid-template-columns:160px 1fr 260px;gap:12px;align-items:center}
.brand-box{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:10px;display:flex;justify-content:center;align-items:center;min-height:88px;box-shadow:var(--shadow)}
.brand-box img{max-width:140px;height:auto}
.title{text-align:center}
.title h1{margin:6px 0 0 0;font-size:22px;font-weight:800}
.title h1 span{display:block;font-size:18px;margin-top:4px}
.title p{margin:2px 0;color:var(--muted);font-size:12px}
.controls{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:8px;box-shadow:var(--shadow)}
.controls .row{display:flex;gap:6px;align-items:center;margin-bottom:6px}
.controls label{font-size:12px;color:#111827;min-width:110px}
.controls input[type=file]{font-size:12px}
.controls .btns{display:flex;gap:6px;justify-content:flex-end}
.btn{padding:8px 12px;border:1px solid var(--ring);background:var(--panel);border-radius:999px;cursor:pointer;font-size:12px}
.btn.primary{background:#111827;color:#fff;border-color:#111827}
.btn:hover{filter:brightness(.97)}

/* winners pill */
.winners{background:var(--panel);border:1px solid var(--gold-border);border-radius:12px;padding:10px 12px;margin:14px 0;box-shadow:var(--shadow)}
.winners .chip{display:inline-flex;gap:8px;align-items:center;background:var(--gold);padding:8px 12px;border:1px solid var(--gold-border);border-radius:10px;color:var(--gold-text);font-weight:800}

/* tabs */
.tabs{display:flex;gap:8px;margin:8px 0 10px 0}
.tab{padding:8px 14px;border:1px solid var(--ring);background:var(--panel);border-radius:999px;cursor:pointer;font-size:12px}
.tab.active{background:var(--subtle)}

/* sections/cards */
.section{background:var(--panel);border:1px solid var(--border);border-radius:12px;margin:10px 0;box-shadow:var(--shadow)}
.section .hd{padding:10px 12px;border-bottom:1px solid var(--border);font-weight:700}
.section .bd{padding:12px}

.grid2{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:1000px){.grid2{grid-template-columns:1fr 1fr}}

.chart{width:100%;height:300px;border:1px solid var(--border);border-radius:10px;background:#fff}
.kpigrid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.kpi{background:#fff;border:1px solid var(--border);border-radius:10px;padding:10px}
.kpi span{display:block;color:var(--muted);font-size:12px;margin-bottom:4px}
.kpi b{font-size:18px}
.badge{display:inline-block;padding:3px 8px;border-radius:999px;font-size:12px;font-weight:700;margin-left:6px}
.badge.red{background:rgba(239,68,68,.12);color:#7f1d1d;border:1px solid rgba(239,68,68,.35)}
.badge.green{background:rgba(16,185,129,.12);color:#065f46;border:1px solid rgba(16,185,129,.35)}

table{width:100%;border-collapse:collapse;border:1px solid var(--border);background:#fff;border-radius:10px;overflow:hidden}
thead th{background:var(--subtle);text-align:left;padding:10px;font-size:13px;border-bottom:1px solid var(--border)}
tbody td{padding:10px;border-bottom:1px solid var(--border);font-size:13px}

/* collapsible sites */
details.site{background:#fff;border:1px solid var(--border);border-radius:10px;margin-bottom:8px}
details.site>summary{cursor:pointer;list-style:none;padding:10px 12px;font-weight:800}
details.site>summary::-webkit-details-marker{display:none}
.site-body{padding:0 12px 12px}
.kv{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.kv div{background:#f9fafb;border:1px solid var(--border);border-radius:8px;padding:8px}
.kv span{color:var(--muted);font-size:12px}

footer{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:11px;margin:10px 0}
footer img{height:26px;border-radius:6px;border:1px solid var(--border)}
.view{display:none}.view.active{display:block}

/* small helpers */
.hidden{display:none}
</style>
</head>
<body>
<div class="container">

  <!-- Header -->
  <div class="header">
    <div class="brand-box">
      <img src="./TabukCluster.jpeg" alt="Tabuk Health Cluster" onerror="this.style.display='none'"/>
    </div>
    <div class="title">
      <h1>Mobile Team Monthly Maintenance KPIs ‚Äì <span>October 2025</span></h1>
      <p>Corrective & Preventive Maintenance ‚Ä¢ Tabuk Health Cluster</p>
      <p>Prepared by: ŸÇÿ≥ŸÖ ÿßŸÑÿµŸäÿßŸÜÿ© ÿßŸÑÿ∑ÿ®Ÿäÿ© ÿ®ÿ™ÿ¨ŸÖÿπ ÿ™ÿ®ŸàŸÉ ÿßŸÑÿµÿ≠Ÿä</p>
    </div>
    <div class="controls">
      <div class="row">
        <label>Corrective Wo.xlsx</label><input type="file" id="file-cm" accept=".xlsx,.xls"/>
      </div>
      <div class="row">
        <label>Preventive ppm.xlsx</label><input type="file" id="file-pm" accept=".xlsx,.xls"/>
      </div>
      <div class="btns">
        <button class="btn primary" id="btn-run">Load & Calculate</button>
        <button class="btn" id="btn-lang">EN / AR</button>
      </div>
    </div>
  </div>

  <!-- Winners pill -->
  <div class="winners">
    <span class="chip">üèÜ October 2025 Winners</span>
    <span id="winners-list" style="margin-left:8px;color:var(--gold-text);font-weight:700"></span>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" id="tab-cm">Corrective (WO)</button>
    <button class="tab" id="tab-pm">Preventive (PPM)</button>
    <button class="tab" id="tab-co">Combined</button>
  </div>

  <!-- Corrective -->
  <div class="view active" id="cm">
    <div class="section"><div class="hd">Summary</div><div class="bd"><div class="kpigrid" id="cm-kpis"></div></div></div>

    <div class="grid2">
      <div class="section"><div class="hd">Top 5 (Response)</div><div class="bd"><svg id="cm-top5-response" class="chart"></svg></div></div>
      <div class="section"><div class="hd">Top 5 (Repair)</div><div class="bd"><svg id="cm-top5-repair" class="chart"></svg></div></div>
    </div>

    <div class="grid2">
      <div class="section"><div class="hd">Finished vs Under Repair</div><div class="bd"><svg id="cm-finished-under" class="chart"></svg></div></div>
      <div class="section"><div class="hd">Completion</div><div class="bd"><svg id="cm-completion" class="chart"></svg></div></div>
    </div>

    <div class="section"><div class="hd">Corrective ‚Äì Ranking (Top 12)</div><div class="bd"><div style="overflow:auto"><table id="cm-rank"></table></div></div></div>
    <div class="section"><div class="hd">Sites ‚Äì Details & Recommendations</div><div class="bd" id="cm-sites"></div></div>
  </div>

  <!-- Preventive -->
  <div class="view" id="pm">
    <div class="section"><div class="hd">Summary</div><div class="bd"><div class="kpigrid" id="pm-kpis"></div></div></div>

    <div class="grid2">
      <div class="section"><div class="hd">Top 5 (Response)</div><div class="bd"><svg id="pm-top5-response" class="chart"></svg></div></div>
      <div class="section"><div class="hd">Top 5 (Repair)</div><div class="bd"><svg id="pm-top5-repair" class="chart"></svg></div></div>
    </div>

    <div class="grid2">
      <div class="section"><div class="hd">Finished vs Under Repair</div><div class="bd"><svg id="pm-finished-under" class="chart"></svg></div></div>
      <div class="section"><div class="hd">Completion</div><div class="bd"><svg id="pm-completion" class="chart"></svg></div></div>
    </div>

    <div class="section"><div class="hd">Preventive ‚Äì Ranking (Top 12)</div><div class="bd"><div style="overflow:auto"><table id="pm-rank"></table></div></div></div>
    <div class="section"><div class="hd">Sites ‚Äì Details & Recommendations</div><div class="bd" id="pm-sites"></div></div>
  </div>

  <!-- Combined -->
  <div class="view" id="co">
    <div class="section"><div class="hd">Summary</div><div class="bd"><div class="kpigrid" id="co-kpis"></div></div></div>

    <div class="grid2">
      <div class="section"><div class="hd">Top 5 (Response)</div><div class="bd"><svg id="co-top5-response" class="chart"></svg></div></div>
      <div class="section"><div class="hd">Top 5 (Repair)</div><div class="bd"><svg id="co-top5-repair" class="chart"></svg></div></div>
    </div>

    <div class="grid2">
      <div class="section"><div class="hd">Finished vs Under Repair</div><div class="bd"><svg id="co-finished-under" class="chart"></svg></div></div>
      <div class="section"><div class="hd">Completion</div><div class="bd"><svg id="co-completion" class="chart"></svg></div></div>
    </div>

    <div class="section"><div class="hd">Combined ‚Äì Ranking (Top 12)</div><div class="bd"><div style="overflow:auto"><table id="co-rank"></table></div></div></div>
    <div class="section"><div class="hd">Sites ‚Äì Details & Recommendations</div><div class="bd" id="co-sites"></div></div>
  </div>

  <footer>
    <img src="./FGC.jpeg" alt="FGC" onerror="this.style.display='none'"/>
    <span id="gentime"></span>
  </footer>

</div>

<script>
/* ÿ£ÿπŸÖÿØÿ© ÿßŸÑŸÖŸÑŸÅ */
const COL={site:'Site',resp:'Response KPI',rep:'Repierd KPI',ecri:'ECRI Code'};

/* ÿ™ÿ®ŸàŸäÿ®ÿßÿ™ */
[['tab-cm','cm'],['tab-pm','pm'],['tab-co','co']].forEach(([b,v])=>{
  document.getElementById(b).addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.view').forEach(x=>x.classList.remove('active'));
    document.getElementById(b).classList.add('active');
    document.getElementById(v).classList.add('active');
  });
});

/* ŸÑÿ∫ÿ© */
document.getElementById('btn-lang').addEventListener('click',()=>{
  const html=document.documentElement;
  if(html.getAttribute('dir')==='rtl'){ html.removeAttribute('dir'); html.setAttribute('lang','en'); }
  else{ html.setAttribute('dir','rtl'); html.setAttribute('lang','ar'); }
});

/* ŸÇÿ±ÿßÿ°ÿ© Excel (ÿ£ŸÉÿ®ÿ± ÿ¥Ÿäÿ™) */
function readExcel(f){
  return new Promise((res,rej)=>{
    const r=new FileReader();
    r.onload=e=>{
      const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});
      const name=wb.SheetNames.reduce((a,b)=>{
        const la=XLSX.utils.sheet_to_json(wb.Sheets[a],{defval:null}).length;
        const lb=XLSX.utils.sheet_to_json(wb.Sheets[b],{defval:null}).length;
        return lb>la?b:a;
      });
      res(XLSX.utils.sheet_to_json(wb.Sheets[name],{defval:null}));
    };
    r.onerror=rej; r.readAsArrayBuffer(f);
  });
}

document.getElementById('btn-run').addEventListener('click',async()=>{
  const fcm=document.getElementById('file-cm').files[0];
  const fpm=document.getElementById('file-pm').files[0];
  if(!fcm||!fpm){ alert('Please select Wo.xlsx and ppm.xlsx'); return; }
  const CM=await readExcel(fcm);
  const PM=await readExcel(fpm);
  renderAll(CM,PM);
  document.getElementById('gentime').textContent='Generated '+new Date().toLocaleString();
});

/* Helpers */
const isNullish=v=>v===null||v===undefined||String(v).trim().toLowerCase()===''||String(v).trim().toLowerCase()==='null';
const toNum=v=>isNullish(v)?NaN:Number(String(v).replaceAll(',',''));
const avg=a=>a.reduce((x,y)=>x+y,0)/a.length;

/* Corrective: open ŸÑŸà Repierd KPI ŸÅÿßÿ∂Ÿä */
function groupCorrective(rows){
  const map=new Map(), devices=new Map();
  rows.forEach(r=>{
    const site=(r[COL.site]??'(blank)').toString().trim();
    const resp=toNum(r[COL.resp]), rep=toNum(r[COL.rep]);
    const open=isNullish(r[COL.rep]);
    if(!map.has(site)) map.set(site,{site,total:0,open:0,resp:[],rep:[]});
    const s=map.get(site); s.total++; if(open) s.open++;
    if(!Number.isNaN(resp)) s.resp.push(resp);
    if(!Number.isNaN(rep)) s.rep.push(rep);
    const d=(r[COL.ecri]??'(blank)').toString().trim();
    devices.set(d,(devices.get(d)||0)+1);
  });
  const arr=[...map.values()].map(s=>({
    site:s.site,total_wo:s.total,open_wo:s.open,closed_wo:s.total-s.open,
    avg_response_days:s.resp.length?avg(s.resp):null,
    avg_repair_days:s.rep.length?avg(s.rep):null,
    open_rate_pct:s.total?(s.open/s.total*100):null
  }));
  const top=[...devices.entries()].sort((a,b)=>b[1]-a[1]).slice(0,10).map(([device,count])=>({device,count}));
  return {arr,top};
}

/* Preventive: ŸÖÿ∫ŸÑŸÇ ŸÑŸà Repierd KPI ÿ±ŸÇŸÖ >=0 ÿõ ŸÖŸÅÿ™Ÿàÿ≠ ŸÑŸà rep ŸÅÿßÿ∂Ÿä ÿ£Ÿà response ŸÅÿßÿ∂Ÿä */
function groupPreventive(rows){
  const map=new Map();
  rows.forEach(r=>{
    const site=(r[COL.site]??'(blank)').toString().trim();
    const resp=toNum(r[COL.resp]), rep=toNum(r[COL.rep]);
    const respBlank=isNullish(r[COL.resp]), repBlank=isNullish(r[COL.rep]);
    const isClosed=Number.isFinite(rep)&&rep>=0;
    const isOpen=repBlank||respBlank;
    const notOpened=respBlank;
    if(!map.has(site)) map.set(site,{site,total:0,open:0,closed:0,notOpened:0,resp:[],rep:[]});
    const s=map.get(site);
    s.total++; if(isOpen) s.open++; if(notOpened) s.notOpened++;
    if(isClosed) s.closed++; else s.closed=s.total-s.open;
    if(!Number.isNaN(resp)) s.resp.push(resp); if(!Number.isNaN(rep)) s.rep.push(rep);
  });
  const arr=[...map.values()].map(s=>({
    site:s.site,total_wo:s.total,open_wo:s.open,closed_wo:s.closed,not_opened:s.notOpened,
    avg_response_days:s.resp.length?avg(s.resp):null,
    avg_repair_days:s.rep.length?avg(s.rep):null,
    open_rate_pct:s.total?(s.open/s.total*100):null
  }));
  return {arr};
}

/* Combine */
function combine(cm,pm){
  const map=new Map();
  function add(a){ a.forEach(r=>{ if(!map.has(r.site)) map.set(r.site,{site:r.site,total:0,open:0,closed:0,resps:[],reps:[]});
    const m=map.get(r.site); m.total+=r.total_wo; m.open+=r.open_wo; m.closed+=r.closed_wo;
    if(Number.isFinite(r.avg_response_days)) m.resps.push(r.avg_response_days);
    if(Number.isFinite(r.avg_repair_days)) m.reps.push(r.avg_repair_days);
  });}
  add(cm); add(pm);
  return [...map.values()].map(m=>({
    site:m.site,total_wo:m.total,open_wo:m.open,closed_wo:m.closed,
    avg_response_days:m.resps.length?avg(m.resps):null,
    avg_repair_days:m.reps.length?avg(m.reps):null,
    open_rate_pct:m.total?(m.open/m.total*100):null
  }));
}
function meta(arr,withNot=false){
  const t=arr.reduce((a,b)=>a+b.total_wo,0), o=arr.reduce((a,b)=>a+b.open_wo,0), c=arr.reduce((a,b)=>a+b.closed_wo,0);
  const or=t?(o/t*100):0, resp=arr.map(x=>x.avg_response_days).filter(Number.isFinite), rep=arr.map(x=>x.avg_repair_days).filter(Number.isFinite);
  const notO=withNot?arr.reduce((a,b)=>a+(b.not_opened||0),0):null;
  return {total_wo:t,open_wo:o,closed_wo:c,open_rate_pct:or,avg_response_days:resp.length?avg(resp):null,avg_repair_days:rep.length?avg(rep):null,not_opened:notO};
}
function rank(rows){
  return rows.slice().sort((a,b)=>{
    const k1=(a.open_rate_pct??1e9)-(b.open_rate_pct??1e9);
    const k2=(a.avg_repair_days??1e9)-(b.avg_repair_days??1e9);
    const k3=(a.avg_response_days??1e9)-(b.avg_response_days??1e9);
    const k4=(b.total_wo??0)-(a.total_wo??0);
    return k1||k2||k3||k4;
  });
}

/* ===== ÿ±ÿ≥ŸàŸÖÿßÿ™ ŸÖÿ∑ÿßÿ®ŸÇÿ© ŸÑŸÑŸëŸäÿßŸàÿ™ ===== */
function top5ByAvg(rows, keyAvg, labelKey='site'){
  const valid = rows.filter(r => Number.isFinite(r[keyAvg]));
  valid.sort((a,b) => a[keyAvg] - b[keyAvg]);
  return valid.slice(0, 5).map(r => ({ label: r[labelKey], value: r[keyAvg] }));
}
function drawBarH(svg, items){ // ÿ£ÿπŸÖÿØÿ© ÿ£ŸÅŸÇŸäÿ©
  const w = svg.clientWidth, h = svg.clientHeight, pad = 40;
  svg.innerHTML = '';
  if(!items.length){
    const t = document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('x', w/2); t.setAttribute('y', h/2);
    t.setAttribute('text-anchor','middle'); t.textContent = 'No data';
    svg.appendChild(t); return;
  }
  const max = Math.max(1, ...items.map(d => +d.value || 0));
  const rowH = (h - pad*2) / items.length;

  const axis = document.createElementNS('http://www.w3.org/2000/svg','line');
  axis.setAttribute('x1', pad); axis.setAttribute('y1', h-pad);
  axis.setAttribute('x2', w-pad); axis.setAttribute('y2', h-pad);
  axis.setAttribute('stroke', '#cbd5e1'); svg.appendChild(axis);

  items.forEach((d,i)=>{
    const y = pad + i*rowH + 6;
    const barW = ((d.value || 0) / max) * (w - pad*2);
    const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
    rect.setAttribute('x', pad); rect.setAttribute('y', y);
    rect.setAttribute('width', Math.max(2, barW)); rect.setAttribute('height', Math.max(10, rowH-12));
    rect.setAttribute('fill', '#f59e0b'); svg.appendChild(rect);

    const label = document.createElementNS('http://www.w3.org/2000/svg','text');
    label.setAttribute('x', pad-6); label.setAttribute('y', y + (rowH-12)/2 + 8);
    label.setAttribute('font-size','11'); label.setAttribute('text-anchor','end');
    label.textContent = d.label; svg.appendChild(label);

    const val = document.createElementNS('http://www.w3.org/2000/svg','text');
    val.setAttribute('x', pad + barW + 6); val.setAttribute('y', y + (rowH-12)/2 + 8);
    val.setAttribute('font-size','11');
    val.textContent = (Number(d.value).toFixed(2)) + ' d'; svg.appendChild(val);
  });
}
function drawStackedFinishedUnder(svg, rows){
  const w = svg.clientWidth, h = svg.clientHeight, pad = 40;
  svg.innerHTML = '';
  const data = rows.slice().sort((a,b)=> (b.total_wo||0) - (a.total_wo||0)).slice(0,8);
  if(!data.length){ const t=document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('x', w/2); t.setAttribute('y', h/2); t.setAttribute('text-anchor','middle'); t.textContent='No data';
    svg.appendChild(t); return; }

  const bw = (w - pad*2) / data.length;
  const max = Math.max(1, ...data.map(d => (d.closed_wo||0) + (d.open_wo||0)));

  const axis = document.createElementNS('http://www.w3.org/2000/svg','line');
  axis.setAttribute('x1', pad); axis.setAttribute('y1', h-pad);
  axis.setAttribute('x2', w-pad); axis.setAttribute('y2', h-pad);
  axis.setAttribute('stroke', '#cbd5e1'); svg.appendChild(axis);

  data.forEach((d,i)=>{
    const x = pad + i*bw + 6;

    const hClosed = ((d.closed_wo||0)/max) * (h - pad*2);
    const rClosed = document.createElementNS('http://www.w3.org/2000/svg','rect');
    rClosed.setAttribute('x', x); rClosed.setAttribute('y', h-pad - hClosed);
    rClosed.setAttribute('width', Math.max(2, bw-12)); rClosed.setAttribute('height', hClosed);
    rClosed.setAttribute('fill', '#10b981'); svg.appendChild(rClosed);

    const hOpen = ((d.open_wo||0)/max) * (h - pad*2);
    const rOpen = document.createElementNS('http://www.w3.org/2000/svg','rect');
    rOpen.setAttribute('x', x); rOpen.setAttribute('y', h-pad - hClosed - hOpen);
    rOpen.setAttribute('width', Math.max(2, bw-12)); rOpen.setAttribute('height', hOpen);
    rOpen.setAttribute('fill', '#ef4444'); svg.appendChild(rOpen);

    const label = document.createElementNS('http://www.w3.org/2000/svg','text');
    label.setAttribute('x', x + (bw-12)/2); label.setAttribute('y', h-10);
    label.setAttribute('text-anchor','middle'); label.setAttribute('font-size','10');
    label.textContent = String(d.site).slice(0,12); svg.appendChild(label);
  });
}
function drawPie(svg,openCount,closedCount){
  const w=svg.clientWidth,h=svg.clientHeight; svg.innerHTML='';
  const r=Math.min(w,h)/2-10,cx=w/2,cy=h/2,tot=Math.max(1,openCount+closedCount);
  const parts=[{v:openCount,col:'var(--red)',label:'Under Repair'},{v:closedCount,col:'var(--green)',label:'Finished'}];
  let a0=-Math.PI/2;
  parts.forEach(p=>{
    const ang=p.v/tot*Math.PI*2,a1=a0+ang,x0=cx+r*Math.cos(a0),y0=cy+r*Math.sin(a0),x1=cx+r*Math.cos(a1),y1=cy+r*Math.sin(a1);
    const big=ang>Math.PI?1:0, path=document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d',`M ${cx} ${cy} L ${x0} ${y0} A ${r} ${r} 0 ${big} 1 ${x1} ${y1} Z`); path.setAttribute('fill',p.col); svg.appendChild(path); a0=a1;
  });
  const t=document.createElementNS('http://www.w3.org/2000/svg','text');
  t.setAttribute('x',w/2);t.setAttribute('y',h-8);t.setAttribute('text-anchor','middle');t.setAttribute('font-size','12');
  t.textContent=`Under Repair ${(openCount/tot*100).toFixed(1)}%`; svg.appendChild(t);
}

/* Ranking & Sites */
function renderRank(table,rows){
  const s=rank(rows), head=['#','site','total_wo','open_wo','closed_wo','open_rate_pct','avg_response_days','avg_repair_days'];
  table.innerHTML=`<thead><tr>${head.map(h=>`<th>${h}</th>`).join('')}</tr></thead><tbody></tbody>`;
  const tb=table.querySelector('tbody');
  s.slice(0,12).forEach((r,i)=>{
    const tr=document.createElement('tr');
    [i+1,r.site,r.total_wo,r.open_wo,r.closed_wo,
     r.open_rate_pct!=null?r.open_rate_pct.toFixed(1)+'%':'‚Äî',
     r.avg_response_days!=null?r.avg_response_days.toFixed(2):'‚Äî',
     r.avg_repair_days!=null?r.avg_repair_days.toFixed(2):'‚Äî'
    ].forEach(v=>{const td=document.createElement('td');td.textContent=v;tr.appendChild(td);});
    tb.appendChild(tr);
  });
}
function recos(r){
  const out=[]; if((r.open_rate_pct||0)>30) out.push('Reduce backlog with daily aging & escalation >7d');
  if((r.avg_repair_days||0)>5) out.push('Improve parts readiness & vendor SLA');
  if((r.avg_response_days||0)>2) out.push('Faster triage/dispatch within 2 hours');
  if(!out.length) out.push('Good performance ‚Äì keep weekly monitoring');
  return out;
}
function renderSites(el,rows){
  el.innerHTML='';
  rows.forEach(r=>{
    const det=document.createElement('details'); det.className='site';
    const sum=document.createElement('summary'); sum.textContent=r.site;
    const body=document.createElement('div'); body.className='site-body';
    const kv=document.createElement('div'); kv.className='kv';
    kv.innerHTML=`
      <div><span>Total WOs</span><b>${r.total_wo}</b></div>
      <div><span>Open WOs</span><b>${r.open_wo} <i class="badge red">Open</i></b></div>
      <div><span>Closed WOs</span><b>${r.closed_wo} <i class="badge green">Closed</i></b></div>
      <div><span>Open %</span><b>${r.open_rate_pct!=null?r.open_rate_pct.toFixed(1)+'%':'‚Äî'}</b></div>
      <div><span>Avg. Response (days)</span><b>${r.avg_response_days!=null?r.avg_response_days.toFixed(2):'‚Äî'}</b></div>
      <div><span>Avg. Repair (days)</span><b>${r.avg_repair_days!=null?r.avg_repair_days.toFixed(2):'‚Äî'}</b></div>`;
    body.innerHTML = kv.outerHTML + `<div style="margin-top:8px"><b>Recommendations</b><ul>${recos(r).map(x=>`<li>${x}</li>`).join('')}</ul></div>`;
    det.appendChild(sum); det.appendChild(body); el.appendChild(det);
  });
}

/* Winners (Top 3 by combined ranking) */
function winners(rows){
  const top=rank(rows).slice(0,3);
  document.getElementById('winners-list').textContent = top.map((r,i)=>`${i+1}) ${r.site}`).join('  ‚Ä¢  ');
}

/* Render All */
function renderAll(CMrows,PMrows){
  const c=groupCorrective(CMrows), p=groupPreventive(PMrows);
  const co=combine(c.arr,p.arr);

  const cmM=meta(c.arr,false), pmM=meta(p.arr,true), coM=meta(co,false);

  // KPIs
  renderKPIs('cm-kpis',cmM,false);
  renderKPIs('pm-kpis',pmM,true);
  renderKPIs('co-kpis',coM,false);

  // ===== Corrective charts =====
  drawBarH(document.getElementById('cm-top5-response'), top5ByAvg(c.arr,'avg_response_days'));
  drawBarH(document.getElementById('cm-top5-repair'),   top5ByAvg(c.arr,'avg_repair_days'));
  drawStackedFinishedUnder(document.getElementById('cm-finished-under'), c.arr);
  drawPie(document.getElementById('cm-completion'), cmM.open_wo, cmM.closed_wo);

  // ===== Preventive charts =====
  drawBarH(document.getElementById('pm-top5-response'), top5ByAvg(p.arr,'avg_response_days'));
  drawBarH(document.getElementById('pm-top5-repair'),   top5ByAvg(p.arr,'avg_repair_days'));
  drawStackedFinishedUnder(document.getElementById('pm-finished-under'), p.arr);
  drawPie(document.getElementById('pm-completion'), pmM.open_wo, pmM.closed_wo);

  // ===== Combined charts =====
  drawBarH(document.getElementById('co-top5-response'), top5ByAvg(co,'avg_response_days'));
  drawBarH(document.getElementById('co-top5-repair'),   top5ByAvg(co,'avg_repair_days'));
  drawStackedFinishedUnder(document.getElementById('co-finished-under'), co);
  drawPie(document.getElementById('co-completion'), coM.open_wo, coM.closed_wo);

  // Tables & details
  renderRank(document.getElementById('cm-rank'),c.arr);
  renderRank(document.getElementById('pm-rank'),p.arr);
  renderRank(document.getElementById('co-rank'),co);
  renderSites(document.getElementById('cm-sites'),c.arr);
  renderSites(document.getElementById('pm-sites'),p.arr);
  renderSites(document.getElementById('co-sites'),co);

  winners(co);
}

/* KPI blocks render */
function renderKPIs(id,m,extra){
  document.getElementById(id).innerHTML = `
    <div class="kpi"><span>Total Work Orders</span><b>${m.total_wo.toLocaleString()}</b></div>
    <div class="kpi"><span>Open Work Orders</span><b>${m.open_wo.toLocaleString()} <i class="badge red">Open</i></b></div>
    <div class="kpi"><span>Closed Work Orders</span><b>${m.closed_wo.toLocaleString()} <i class="badge green">Closed</i></b></div>
    <div class="kpi"><span>Open Rate</span><b>${m.open_rate_pct.toFixed(1)}%</b></div>
    <div class="kpi"><span>Avg. Response (days)</span><b>${m.avg_response_days!=null?m.avg_response_days.toFixed(2):'‚Äî'}</b></div>
    <div class="kpi"><span>Avg. Repair (days)</span><b>${m.avg_repair_days!=null?m.avg_repair_days.toFixed(2):'‚Äî'}</b></div>
    ${extra && m.not_opened!=null ? `<div class="kpi"><span>Not Opened (Response KPI blank)</span><b>${m.not_opened.toLocaleString()}</b></div>`:''}
  `;
}
</script>
</body>
</html>
